<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Read PDFs from Google Drive folder + ChatGPT Summary</title>
  <style>
    body { font-family: system-ui, Arial; padding: 18px; max-width: 980px; margin: auto; }
    button { padding:10px 14px; margin-right:8px; cursor:pointer; }
    .thumb { width:140px; margin:6px; border:1px solid #ddd; }
    .images { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    textarea { width:100%; height:160px; margin-top:8px; }
    .file-entry { border:1px solid #eee; padding:10px; border-radius:6px; margin-top:10px; }
  </style>
</head>

<body>
  <h2>Drive Folder PDF Reader (OAuth) + ChatGPT Summarizer</h2>
  <p>This loads 2 PDFs from Google Drive, extracts text + images, then summarizes both using ChatGPT.</p>

  <div>
    <button id="authBtn">Sign in & load PDFs</button>
    <button id="signoutBtn" style="display:none">Sign out</button>
  </div>

  <div id="status" style="margin-top:12px;color:#333"></div>

  <h3>Files found</h3>
  <div id="filesList"></div>

  <h3>Combined extracted text</h3>
  <textarea id="combinedText" placeholder="Extracted text will appear here..."></textarea>

  <h3>Thumbnails</h3>
  <div id="images" class="images"></div>

  <!-- pdf.js -->
  <script src="https://unpkg.com/pdfjs-dist@3.6.172/build/pdf.min.js"></script>
  <!-- Google API client -->
  <script src="https://apis.google.com/js/api.js"></script>
  <!-- Google OAuth -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
// ==================== CONFIG ====================
const BACKEND_URL = "https://pdf-summarize-3go5.onrender.com/summarize"; // your working backend

const OAUTH_CLIENT_ID = '365509237422-i3lq53klim7uk6ub0ndh1vag17078lkm.apps.googleusercontent.com';
const API_KEY = 'AIzaSyCQMc9sbjDLsYsSzrpdGyyXUH4q0uCb5UE';
const TARGET_FOLDER_ID = '1uheM2o-LZsoslFv59ccQox4PUjAL0PjS';
const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

// pdf.js worker
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.6.172/build/pdf.worker.min.js';

// UI refs
const authBtn = document.getElementById('authBtn');
const signoutBtn = document.getElementById('signoutBtn');
const statusEl = document.getElementById('status');
const filesList = document.getElementById('filesList');
const combinedTextEl = document.getElementById('combinedText');
const imagesDiv = document.getElementById('images');

let gapiInited = false;
let tokenClient;
let accessToken = null;

// ==================== GOOGLE LOGIN ====================
function gapiLoaded() {
  gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
  try {
    await gapi.client.init({
      apiKey: API_KEY,
      discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
    });
    gapiInited = true;
    statusEl.textContent = 'Google API client initialized.';
  } catch (err) {
    statusEl.textContent = 'Error initializing gapi: ' + err.message;
  }
}

function waitForGoogleThenInitTokenClient() {
  return new Promise((resolve, reject) => {
    const start = Date.now();
    (function check() {
      if (window.google && google.accounts && google.accounts.oauth2) {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: OAUTH_CLIENT_ID,
          scope: SCOPES,
          callback: (resp) => {
            if (resp.error) return alert("Auth error");
            accessToken = resp.access_token;
            authBtn.style.display = "none";
            signoutBtn.style.display = "inline-block";
            statusEl.textContent = "Signed in.";
            listPdfFilesInFolder();
          }
        });
        resolve();
      } else if (Date.now() - start > 5000) {
        reject(new Error("Google Identity Services did not load"));
      } else setTimeout(check, 100);
    })();
  });
}

async function signOut() {
  if (accessToken) {
    await fetch(`https://oauth2.googleapis.com/revoke?token=${accessToken}`, { method: 'POST' });
  }
  accessToken = null;
  statusEl.textContent = "Signed out.";
  authBtn.style.display = "";
  signoutBtn.style.display = "none";
  filesList.innerHTML = "";
  combinedTextEl.value = "";
  imagesDiv.innerHTML = "";
}

// ==================== LIST & DOWNLOAD PDFs ====================
async function listPdfFilesInFolder() {
  if (!gapiInited) return alert("gapi not ready");

  statusEl.textContent = "Listing PDFs...";
  filesList.innerHTML = "";
  combinedTextEl.value = "";
  imagesDiv.innerHTML = "";

  const q = `'${TARGET_FOLDER_ID}' in parents and mimeType='application/pdf' and trashed=false`;

  try {
    const resp = await gapi.client.drive.files.list({
      q,
      fields: "files(id,name,size)"
    });

    const files = resp.result.files || [];
    if (!files.length) return statusEl.textContent = "No PDFs found.";

    let allText = "";

    for (const f of files) {
      const div = document.createElement("div");
      div.className = "file-entry";
      div.innerHTML = `<b>${f.name}</b> (${f.size} bytes)`;
      filesList.appendChild(div);

      const buf = await downloadFileAsArrayBuffer(f.id);
      const parsed = await extractPdfTextAndThumbnails(buf, f.name);

      allText += parsed.text + "\n\n";
      parsed.thumbs.forEach(t => {
        const img = document.createElement("img");
        img.src = t.dataUrl;
        img.className = "thumb";
        imagesDiv.appendChild(img);
      });

      div.appendChild(document.createElement("div")).innerText = "Parsed OK";
    }

    combinedTextEl.value = allText;
    statusEl.textContent = "PDFs processed.";

  } catch (err) {
    statusEl.textContent = "Error listing files: " + err.message;
  }
}

async function downloadFileAsArrayBuffer(id) {
  const url = `https://www.googleapis.com/drive/v3/files/${id}?alt=media`;

  const resp = await fetch(url, {
    headers: { Authorization: "Bearer " + accessToken }
  });

  if (!resp.ok) throw new Error("Download failed");
  return await resp.arrayBuffer();
}

async function extractPdfTextAndThumbnails(buf, name) {
  const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
  let text = "";
  const thumbs = [];

  for (let p = 1; p <= pdf.numPages; p++) {
    const page = await pdf.getPage(p);
    const t = await page.getTextContent();
    const pageText = t.items.map(i => i.str).join(" ");
    text += `\n--- ${name} PAGE ${p} ---\n` + pageText;

    const viewport = page.getViewport({ scale: 1.2 });
    const canvas = document.createElement("canvas");
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    const ctx = canvas.getContext("2d");
    await page.render({ canvasContext: ctx, viewport }).promise;

    thumbs.push({ dataUrl: canvas.toDataURL("image/jpeg", 0.8) });
  }

  return { text, thumbs };
}

// ==================== CHATGPT SUMMARIZER ====================
const summarizeBtn = document.createElement("button");
summarizeBtn.textContent = "Summarize with ChatGPT";
summarizeBtn.style.marginTop = "20px";

const resultBox = document.createElement("textarea");
resultBox.placeholder = "ChatGPT summary will appear here...";
resultBox.style.height = "220px";
resultBox.style.marginTop = "10px";

document.body.appendChild(summarizeBtn);
document.body.appendChild(resultBox);

summarizeBtn.addEventListener("click", async () => {
  const text = combinedTextEl.value.trim();
  if (text.length < 20) return alert("Load PDFs first!");

  summarizeBtn.disabled = true;
  summarizeBtn.textContent = "Summarizing...";

  try {
    const resp = await fetch(BACKEND_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text })
    });

    const data = await resp.json();
    resultBox.value = data.summary || "No output from ChatGPT";

  } catch (e) {
    resultBox.value = "Error: " + e.message;
  }

  summarizeBtn.disabled = false;
  summarizeBtn.textContent = "Summarize with ChatGPT";
});

// ==================== BOOT ====================
authBtn.addEventListener("click", async () => {
  if (!gapiInited) {
    await new Promise(r => gapi.load('client', r));
    await initializeGapiClient();
  }
  await waitForGoogleThenInitTokenClient();
  tokenClient.requestAccessToken();
});

signoutBtn.addEventListener("click", signOut);

window.onload = () => {
  if (typeof gapi === "undefined") {
    statusEl.textContent = "Google API failed to load.";
  } else {
    gapiLoaded();
    statusEl.textContent = "Ready. Click 'Sign in & load PDFs'.";
  }
};
</script>

</body>
</html>
