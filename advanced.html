<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Advanced ERA — Fill, Figures & Upload</title>

  <!-- dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      --paper-width:210mm;
      --font: "Segoe UI", Roboto, Arial, sans-serif;
      --base-font:14px;
      --muted:#6b7280;
      --accent:#0b61ff;
    }
    * { box-sizing: border-box; }
    body {
      font-family: var(--font);
      background:#f4f6f8;
      margin:0;
      padding:20px;
      display:flex;
      justify-content:center;
    }

    .sheet {
      width:900px;
      max-width:calc(100% - 40px);
      background:#fff;
      padding:18px;
      border-radius:8px;
      box-shadow:0 8px 28px rgba(2,6,23,0.06);
    }

    .answer-row {
  display: flex;
  align-items: flex-start;
  margin-top: 8px;
  gap: 10px;
}

.ans-num {
  font-weight: 700;
  font-size: 16px;
  min-width: 30px;
  margin-top: 6px;
}

.ans-long {
  flex: 1;
  height: 70px;
  border: 1px solid #cfd4dc;
  border-radius: 6px;
  padding: 8px;
  font-size: 14px;
  resize: vertical;
}


    header { text-align:center; margin-bottom:8px; }
    header h1 { margin:4px 0 2px; font-size:18px; }
    header p { margin:0; color:var(--muted); font-size:13px; }

    .meta-row { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:10px; }
    .field { flex:1 1 200px; display:flex; flex-direction:column; }
    label { font-weight:600; font-size:13px; margin-bottom:6px; color:#111827; }
    input[type="text"], input[type="email"], input[type="tel"], input[type="date"], textarea {
      padding:10px;
      border:1px solid #e6e9ee;
      border-radius:6px;
      line-height: 1.4;            /* avoid text clipping */
      font-size:var(--base-font);
      background:transparent;
    }
    textarea { min-height:90px; resize:vertical; }

    .section-title { font-weight:800; margin-top:10px; font-size:14px; color:#0f172a; }

    .questions { margin-top:10px; display:flex; flex-direction:column; gap:12px; }
    .question { padding:12px; border-radius:8px; border:1px solid #eef2f6; background:#fbfdff; page-break-inside:avoid; }
    .q-head { display:flex; gap:12px; align-items:flex-start; }
    .q-num { font-weight:800; color:#0b3d91; min-width:28px; }
    .q-text { font-weight:700; }

    .figures-row { display:flex; gap:12px; flex-wrap:wrap; margin-top:8px; }
    .figure { width:180px; border:1px solid #eef5ff; padding:6px; border-radius:6px; text-align:center; background:#fff; }
    .figure img { max-width:100%; height:auto; display:block; margin:0 auto 6px; }
    .figure .cap { font-size:13px; color:var(--muted); }

    table.layout { width:100%; border-collapse:collapse; margin-top:8px; }
    table.layout th, table.layout td { border:1px solid #e6e9ee; padding:8px; text-align:left; vertical-align:middle; }
    table.layout th { background:#f8fafc; font-weight:700; }

    .controls { display:flex; gap:8px; margin-top:14px; align-items:center; flex-wrap:wrap; }
    button { padding:10px 14px; border-radius:8px; border:0; cursor:pointer; font-weight:700; }
    .btn-primary { background:var(--accent); color:white; }
    .btn-secondary { background:#6b7280; color:white; }
    .status { margin-left:6px; color:var(--muted); font-size:13px; }
    .result-link { margin-top:12px; }

    @media (max-width:760px) {
      .meta-row { flex-direction:column; }
      .figure { width:100%; }
    }

    @media print {
      .controls, .status { display:none; }
      input, textarea { border:none; }
      .figure { border:none; padding:0; }
    }
  </style>
</head>
<body>
  <div class="sheet" id="captureArea">

    <header>
      <h1>Advanced Ergonomics Risk Assessment (Written Assessment)</h1>
      <p class="small">Fill the answers. Default figures (Figure_1.png … Figure_5.png) preload if present.</p>
    </header>

    <div class="meta-row" aria-label="personal details">
      <div class="field"><label>Name:</label><input id="name" type="text" placeholder="Name"></div>
      <div class="field"><label>NRIC No:</label><input id="nric" type="text" placeholder="NRIC No"></div>
      <div class="field"><label>Date:</label><input id="date" type="date"></div>
      <div class="field"><label>Email:</label><input id="email" type="email" placeholder="email@example.com"></div>
      <div class="field"><label>Tel:</label><input id="tel" type="tel" placeholder="Telephone"></div>
    </div>

    <div class="section-title">Questions</div>

    <div class="questions">
      <!-- Q1 -->
<div class="question">
  <div class="q-head">
    <div class="q-num">1</div>
    <div class="q-text">List TWO (2) tools can be used to assess posture. (Write full name of the tools and not abbreviation)</div>
  </div>

  <div class="answer-row">
    <div class="ans-num">1)</div>
    <textarea class="ans-long" id="q1_1"></textarea>
  </div>

  <div class="answer-row">
    <div class="ans-num">2)</div>
    <textarea class="ans-long" id="q1_2"></textarea>
  </div>
</div>

      <!-- Q2 -->
<div class="question">
  <div class="q-head">
    <div class="q-num">2</div>
    <div class="q-text">List TWO (2) scenarios where RULA can be used for assessment</div>
  </div>

  <div class="answer-row">
    <div class="ans-num">1)</div>
    <textarea class="ans-long" id="q2_1"></textarea>
  </div>

  <div class="answer-row">
    <div class="ans-num">2)</div>
    <textarea class="ans-long" id="q2_2"></textarea>
  </div>
</div>


      <!-- Q3 -->
<div class="question">
  <div class="q-head">
    <div class="q-num">3</div>
    <div class="q-text">There are different ways to select which posture to assess depending on the purpose of the assessment. List THREE (3) of them.</div>
  </div>

  <div class="answer-row">
    <div class="ans-num">1)</div>
    <textarea class="ans-long" id="q3_1"></textarea>
  </div>

  <div class="answer-row">
    <div class="ans-num">2)</div>
    <textarea class="ans-long" id="q3_2"></textarea>
  </div>

  <div class="answer-row">
    <div class="ans-num">3)</div>
    <textarea class="ans-long" id="q3_3"></textarea>
  </div>
</div>

      <!-- Q4 + Figure 1 -->
      <div class="question">
        <div class="q-head">
          <div style="display:flex;gap:12px;align-items:flex-start;">
            <div class="q-num">4</div>
            <div class="q-text">Based on Figure 1, which tool you will use to assess his posture and what is the score for back and right upper arm posture.</div>
          </div>
        </div>

        <div style="margin-top:10px; display:flex; gap:18px; align-items:flex-start; flex-wrap:wrap;">
          <!-- static figure block (will show Figure_1.png if available) -->
          <div class="figure" style="flex:0 0 240px;">
            <img id="F1" src="Figure 1 Advanced ERA.jpg" alt="Figure 1 (place Figure_1.png in same folder)" onerror="this.style.display='none'">
            <div class="cap">Figure 1</div>
          </div>

          <div style="flex:1 1 380px;">
            <div style="margin-bottom:8px;"><label>Tool:</label><input id="q4_tool" type="text" style="width:100%; margin-top:6px;" placeholder="Tool: __________________________________"></div>
            <div style="display:flex; gap:8px;">
              <div style="flex:1;"><label>Back Score:</label><input id="q4_back" type="text" style="width:100%; margin-top:6px;" placeholder="Back Score"></div>
              <div style="flex:1;"><label>Upper arm score:</label><input id="q4_arm" type="text" style="width:100%; margin-top:6px;" placeholder="Upper arm score"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Q5 -->
<div class="question" id="q5_block">
  <div class="q-head">
    <div class="q-num">5</div>
    <div class="q-text">Define repetitive task and give ONE (1) example of repetitive task</div>
  </div>

  <div class="answer-row" style="margin-top:8px;">
    <div class="ans-num">Answer</div>
    <textarea class="ans-long" id="q5" placeholder="Definition & example..."></textarea>
  </div>
</div>


      <!-- Q6 -->
<div class="question" id="q6_block">
  <div class="q-head">
    <div class="q-num">6</div>
    <div class="q-text">List TWO (2) tools can be used to repetitive task (or repetition). (Write full name of the tools and not abbreviation)</div>
  </div>

  <div class="answer-row">
    <div class="ans-num">1)</div>
    <textarea class="ans-long" id="q6_1" placeholder="Tool 1 — full name"></textarea>
  </div>

  <div class="answer-row">
    <div class="ans-num">2)</div>
    <textarea class="ans-long" id="q6_2" placeholder="Tool 2 — full name"></textarea>
  </div>
</div>


      <!-- Q7 + Figure 2 -->
      <div class="question">
        <div class="q-head"><div class="q-num">7</div><div class="q-text">Based on Figure 2 — Answer:</div></div>
        <div style="margin-top:10px; display:flex; gap:18px; flex-wrap:wrap;">
          <div class="figure" style="flex:0 0 240px;">
            <img id="F2" src="Figure 2 Advanced ERA.jpg" alt="Figure 2" onerror="this.style.display='none'">
            <div class="cap">Figure 2</div>
          </div>

          <div style="flex:1 1 420px;">
            <div style="margin-bottom:8px;">
              <div><strong>Repetition — If worker cuts 25 chickens per minute</strong></div>
              <div style="display:flex; gap:8px; margin-top:6px;">
                <input id="q7_rep_score" placeholder="Score">
                <input id="q7_rep_band" placeholder="Color band">
              </div>
            </div>

            <div style="margin-bottom:8px;">
              <div><strong>Force — If worker holds & grips knife almost all the time</strong></div>
              <div style="display:flex; gap:8px; margin-top:6px;">
                <input id="q7_force_score" placeholder="Score">
                <input id="q7_force_band" placeholder="Color band">
              </div>
            </div>

            <div>
              <div><strong>Break — If task continuous without break for 1h30m</strong></div>
              <div style="display:flex; gap:8px; margin-top:6px;">
                <input id="q7_break_score" placeholder="Score">
                <input id="q7_break_band" placeholder="Color band">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Q8 -->
      <!-- Q8 -->
<div class="question" id="q8_block">
  <div class="q-head">
    <div class="q-num">8</div>
    <div class="q-text">List TWO (2) tools can be used to Forceful Exertion (or Excessive Force). (Write full name of the tools and not the abbreviation)</div>
  </div>

  <div class="answer-row">
    <div class="ans-num">1)</div>
    <textarea class="ans-long" id="q8_1" placeholder="Tool 1 — full name"></textarea>
  </div>

  <div class="answer-row">
    <div class="ans-num">2)</div>
    <textarea class="ans-long" id="q8_2" placeholder="Tool 2 — full name"></textarea>
  </div>
</div>


      <!-- Q9 -->
<div class="question" id="q9_block">
  <div class="q-head">
    <div class="q-num">9</div>
    <div class="q-text">What are the THREE (3) types of operations can be assessed using MAC tool</div>
  </div>

  <div class="answer-row">
    <div class="ans-num">1)</div>
    <textarea class="ans-long" id="q9_1" placeholder="Operation type 1"></textarea>
  </div>

  <div class="answer-row">
    <div class="ans-num">2)</div>
    <textarea class="ans-long" id="q9_2" placeholder="Operation type 2"></textarea>
  </div>

  <div class="answer-row">
    <div class="ans-num">3)</div>
    <textarea class="ans-long" id="q9_3" placeholder="Operation type 3"></textarea>
  </div>
</div>


      <!-- Q10 + Figure 3 -->
      <div class="question">
        <div class="q-head"><div class="q-num">10</div><div class="q-text">Based on Figure 3 & scenario — Answer:</div></div>
        <div style="margin-top:10px; display:flex; gap:18px; flex-wrap:wrap;">
          <div class="figure" style="flex:0 0 240px;">
            <img id="F3" src="Figure 3 Advanced ERA.jpg" alt="Figure 3" onerror="this.style.display='none'">
            <div class="cap">Figure 3</div>
          </div>
          <div style="flex:1 1 420px;">
            <div style="margin-bottom:8px;"><strong>Load Weight — bag weight 25kg, transfer one bag everyday</strong>
              <div style="display:flex; gap:8px; margin-top:6px;">
                <input id="q10_load_score" placeholder="Score">
                <input id="q10_load_band" placeholder="Color band">
              </div>
            </div>
            <div><strong>Hand distance from lower back</strong>
              <div style="display:flex; gap:8px; margin-top:6px;">
                <input id="q10_hand_score" placeholder="Score">
                <input id="q10_hand_band" placeholder="Color band">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Q11 -->
<div class="question" id="q11_block">
  <div class="q-head">
    <div class="q-num">11</div>
    <div class="q-text">What are the TWO (2) types of operations that can be assessed using the RAPP tool</div>
  </div>

  <div class="answer-row" style="margin-top:8px;">
    <div class="ans-num">1)</div>
    <textarea class="ans-long" id="q11_1" placeholder="Operation type 1"></textarea>
  </div>

  <div class="answer-row">
    <div class="ans-num">2)</div>
    <textarea class="ans-long" id="q11_2" placeholder="Operation type 2"></textarea>
  </div>
</div>

      <!-- Q12 + Figure 4 -->
      <div class="question">
        <div class="q-head"><div class="q-num">12</div><div class="q-text">Based on Figure 4 — Answer:</div></div>
        <div style="margin-top:10px; display:flex; gap:18px; flex-wrap:wrap;">
          <div class="figure" style="flex:0 0 240px;">
            <img id="F4" src="Figure 4 Advanced ERA.jpg" alt="Figure 4" onerror="this.style.display='none'">
            <div class="cap">Figure 4</div>
          </div>
          <div style="flex:1 1 420px;">
            <div style="margin-bottom:8px;"><strong>Load Weight — drum 300kg</strong>
              <div style="display:flex; gap:8px; margin-top:6px;">
                <input id="q12_load_score" placeholder="Score">
                <input id="q12_load_band" placeholder="Color band">
              </div>
            </div>
            <div><strong>Posture</strong>
              <div style="display:flex; gap:8px; margin-top:6px;">
                <input id="q12_posture_score" placeholder="Score">
                <input id="q12_posture_band" placeholder="Color band">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Q13 -->
      <div class="question">
        <div class="q-head"><div class="q-num">13</div><div class="q-text">For ROSA assessment, what is/are the score(s) that deemed to be HIGH RISK</div></div>
        <div style="margin-top:8px;">
          <input id="q13" type="text" placeholder="Answer (scores)...">
        </div>
      </div>

      <!-- Q14 + Figure 5 -->
      <div class="question">
        <div class="q-head"><div class="q-num">14</div><div class="q-text">Based on Figure 5 — Answer:</div></div>
        <div style="margin-top:10px; display:flex; gap:18px; flex-wrap:wrap;">
          <div class="figure" style="flex:0 0 240px;">
            <img id="F5" src="Figure 5 Advanced ERA.jpg" alt="Figure 5" onerror="this.style.display='none'">
            <div class="cap">Figure 5</div>
          </div>
          <div style="flex:1 1 420px;">
            <div style="margin-bottom:8px;"><strong>Back support — worker is leaning forward and back support is non-adjustable</strong>
              <div style="margin-top:6px;"><input id="q14_back_score" placeholder="Score"></div>
            </div>
            <div><strong>Monitor — no glare and no document holder required</strong>
              <div style="margin-top:6px;"><input id="q14_monitor_score" placeholder="Score"></div>
            </div>
          </div>
        </div>
      </div>

    </div> <!-- end questions -->

    <div class="controls">
      <button class="btn-secondary" onclick="resetForm()">Reset</button>
      <button class="btn-primary" id="uploadBtn" onclick="generatePDF()">Generate & Upload PDF</button>
      <div class="status" id="status">Ready</div>
    </div>

    <div class="result-link" id="resultLink"></div>
  </div>

  <script>
  // --- Google Drive OAuth / upload setup ---
  const OAUTH_CLIENT_ID = '365509237422-i3lq53klim7uk6ub0ndh1vag17078lkm.apps.googleusercontent.com';
  const DRIVE_UPLOAD_SCOPE = 'https://www.googleapis.com/auth/drive.file';
  const TARGET_FOLDER_ID = '1ObyTWIF6tx1-G-SpLlMAZGXgMj9oBfbc';

  let tokenClient = null;

  function initGIS() {
    if (!window.google || tokenClient) return;
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: OAUTH_CLIENT_ID,
      scope: DRIVE_UPLOAD_SCOPE,
      callback: () => {}
    });
  }

  window.addEventListener('load', () => initGIS());

  function requestDriveToken() {
    return new Promise((resolve, reject) => {
      if (!tokenClient) return reject(new Error('Google Identity Services not initialized.'));
      tokenClient.callback = (resp) => { if (resp.error) reject(resp); else resolve(resp.access_token); };
      tokenClient.requestAccessToken({ prompt: 'consent' });
    });
  }

  async function uploadPdfToDrive(blob, filename) {
    const token = await requestDriveToken();
    const metadata = { name: filename, mimeType: 'application/pdf', parents: [TARGET_FOLDER_ID] };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', blob, filename);

    const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink', {
      method: 'POST',
      headers: { Authorization: `Bearer ${token}` },
      body: form
    });

    if (!res.ok) {
      const txt = await res.text();
      throw new Error('Upload failed: ' + res.status + ' ' + txt);
    }
    return await res.json();
  }

  // --- Slicing-aware generatePDF() (measures DOM, renders canvas, slices into A4 pages, uploads) ---
  async function generatePDF() {
    const status = document.getElementById('status');
    status.textContent = 'Preparing PDF…';

    const captureEl = document.getElementById('captureArea');
    const scale = 2.5; // adjust for quality/memory: 1.5-2.5

    // measure DOM rectangles relative to captureEl
    const capRect = captureEl.getBoundingClientRect();

    // sections (.question) to avoid cutting inside
    const sectionRects = Array.from(captureEl.querySelectorAll('.question')).map(el => {
      const r = el.getBoundingClientRect();
      return { el, topPxDom: r.top - capRect.top, bottomPxDom: r.bottom - capRect.top, heightPxDom: r.height };
    });

    // collect table rows and table header info (if any tables used)
    const rowRects = [];
    const tableInfos = [];
    const tables = Array.from(captureEl.querySelectorAll('table'));
    tables.forEach(table => {
      const trRect = table.getBoundingClientRect();
      const tableTopDom = trRect.top - capRect.top;
      const tableBottomDom = trRect.bottom - capRect.top;

      // detect header (thead or first tr)
      let headerRectDom = null;
      const thead = table.querySelector('thead');
      if (thead) {
        const hr = thead.getBoundingClientRect();
        headerRectDom = { top: hr.top - capRect.top, height: hr.height, bottom: hr.bottom - capRect.top };
      } else {
        const firstTr = table.querySelector('tr');
        if (firstTr) {
          const hr = firstTr.getBoundingClientRect();
          headerRectDom = { top: hr.top - capRect.top, height: hr.height, bottom: hr.bottom - capRect.top };
        }
      }

      // gather rows
      const rows = Array.from(table.querySelectorAll('tr'));
      rows.forEach(tr => {
        const rr = tr.getBoundingClientRect();
        rowRects.push({ el: tr, topPxDom: rr.top - capRect.top, bottomPxDom: rr.bottom - capRect.top, heightPxDom: rr.height, table });
      });

      tableInfos.push({ table, tableTopDom, tableBottomDom, headerRectDom });
    });

    // convert DOM px -> canvas px (html2canvas will multiply DOM px by scale)
    const domToCanvasPx = domPx => Math.round(domPx * scale);

    try {
      status.textContent = 'Rendering canvas… (may take a few seconds)';
      const canvas = await html2canvas(captureEl, { scale, useCORS: true, logging: false, scrollY: -window.scrollY });

      status.textContent = 'Slicing pages…';

      // convert rects to canvas pixel coordinates
      const sectionRectsCanvas = sectionRects.map(s => ({ topPx: domToCanvasPx(s.topPxDom), bottomPx: domToCanvasPx(s.bottomPxDom), heightPx: domToCanvasPx(s.heightPxDom), el: s.el }));
      const rowRectsCanvas = rowRects.map(r => ({ topPx: domToCanvasPx(r.topPxDom), bottomPx: domToCanvasPx(r.bottomPxDom), heightPx: domToCanvasPx(r.heightPxDom), el: r.el, table: r.table }));
      const tableInfosCanvas = tableInfos.map(ti => ({ table: ti.table, tableTopPx: domToCanvasPx(ti.tableTopDom), tableBottomPx: domToCanvasPx(ti.tableBottomDom), headerRect: ti.headerRectDom ? { topPx: domToCanvasPx(ti.headerRectDom.top), heightPx: domToCanvasPx(ti.headerRectDom.height), bottomPx: domToCanvasPx(ti.headerRectDom.bottom) } : null }));

      // prepare jsPDF
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });
      const pageWidthMm = pdf.internal.pageSize.getWidth();
      const pageHeightMm = pdf.internal.pageSize.getHeight();

      // px->mm converter (must use same scale & 96 DPI)
      const pxToMm = px => px * 25.4 / (96 * scale);

      // compute page slice height in canvas px (leave margins)
      const marginYmm = 8;
      const usablePageHeightMm = pageHeightMm - marginYmm * 2;
      const pageHeightPx = Math.round((usablePageHeightMm * (96 / 25.4)) * scale);
      const minPagePx = Math.max(400, pageHeightPx);

      let yPos = 0;
      const canvasW = canvas.width;
      let pageIndex = 0;

      while (yPos < canvas.height) {
        let sliceEnd = Math.min(yPos + pageHeightPx, canvas.height);

        // avoid cutting inside a .question
        const cuttingSections = sectionRectsCanvas.filter(s => (s.topPx < sliceEnd && s.bottomPx > sliceEnd && s.topPx > yPos));
        if (cuttingSections.length > 0) {
          const nearestSection = cuttingSections.reduce((a, b) => a.topPx < b.topPx ? a : b);
          sliceEnd = nearestSection.topPx;
        }

        // avoid cutting inside rows
        const cuttingRows = rowRectsCanvas.filter(r => (r.topPx < sliceEnd && r.bottomPx > sliceEnd && r.topPx > yPos));
        if (cuttingRows.length > 0) {
          const nearestRow = cuttingRows.reduce((a, b) => a.topPx < b.topPx ? a : b);
          const candidateSlice = nearestRow.topPx;
          const wouldCutSection = sectionRectsCanvas.some(s => (s.topPx < candidateSlice && s.bottomPx > candidateSlice && s.topPx > yPos));
          if (!wouldCutSection) sliceEnd = candidateSlice;
        }

        // progress guard
        if (sliceEnd <= yPos) {
          const nextRowAfter = rowRectsCanvas.find(r => r.topPx > yPos);
          const nextSectionAfter = sectionRectsCanvas.find(s => s.topPx > yPos);
          if (nextSectionAfter && (!nextRowAfter || nextSectionAfter.bottomPx < nextRowAfter.bottomPx)) {
            sliceEnd = nextSectionAfter.bottomPx;
          } else if (nextRowAfter) {
            sliceEnd = nextRowAfter.bottomPx;
          } else {
            sliceEnd = Math.min(yPos + pageHeightPx, canvas.height);
          }
          if (sliceEnd <= yPos) sliceEnd = Math.min(yPos + pageHeightPx, canvas.height);
        }

        const sliceHeight = sliceEnd - yPos;

        // if slice starts mid-table, capture header to repeat
        const tableContinues = tableInfosCanvas.find(ti => (ti.tableTopPx < yPos && ti.tableBottomPx > yPos));
        let headerCanvas = null;
        let headerHeightPx = 0;
        if (tableContinues && tableContinues.headerRect) {
          headerHeightPx = tableContinues.headerRect.heightPx;
          headerCanvas = document.createElement('canvas');
          headerCanvas.width = canvasW;
          headerCanvas.height = headerHeightPx;
          const hctx = headerCanvas.getContext('2d');
          hctx.drawImage(canvas, 0, tableContinues.headerRect.topPx, canvasW, headerHeightPx, 0, 0, canvasW, headerHeightPx);
        }

        // create page canvas (header + slice)
        const pageCanvas = document.createElement('canvas');
        pageCanvas.width = canvasW;
        pageCanvas.height = headerHeightPx + sliceHeight;
        const pctx = pageCanvas.getContext('2d');

        if (headerCanvas) pctx.drawImage(headerCanvas, 0, 0);
        pctx.drawImage(canvas, 0, yPos, canvasW, sliceHeight, 0, headerHeightPx, canvasW, sliceHeight);

        // add page image to pdf (fit to page with margins)
        const imageData = pageCanvas.toDataURL('image/png', 1.0);
        const imageWidthMm = pxToMm(pageCanvas.width);
        const imageHeightMm = pxToMm(pageCanvas.height);

        const marginX = 6; const marginY = 8;
        const usableWidth = pageWidthMm - marginX * 2;
        const usableHeight = pageHeightMm - marginY * 2;

        const ratio = Math.min(usableWidth / imageWidthMm, usableHeight / imageHeightMm);
        const renderW = imageWidthMm * ratio;
        const renderH = imageHeightMm * ratio;
        const x = (pageWidthMm - renderW) / 2;
        const y = marginY;

        if (pageIndex > 0) pdf.addPage();
        pdf.addImage(imageData, 'PNG', x, y, renderW, renderH);

        pageIndex++;
        yPos = sliceEnd;
      } // end while

      // produce blob & upload
      const blob = await pdf.output('blob');
      const nameField = (document.getElementById('name')||{}).value || 'anon';
      const filename = `Advanced_ERA_${nameField}_${new Date().toISOString().replace(/[:.]/g,'-')}.pdf`;

      // uploading indicator
      const uploadingMsg = document.createElement('div');
      uploadingMsg.id = 'uploadingMsg';
      uploadingMsg.style.position = 'fixed';
      uploadingMsg.style.right = '12px';
      uploadingMsg.style.bottom = '12px';
      uploadingMsg.style.padding = '10px 14px';
      uploadingMsg.style.background = '#0b61ff';
      uploadingMsg.style.color = '#fff';
      uploadingMsg.style.borderRadius = '8px';
      uploadingMsg.style.zIndex = '9999';
      uploadingMsg.textContent = 'Uploading PDF to Google Drive…';
      document.body.appendChild(uploadingMsg);
      status.textContent = 'Uploading to Google Drive…';

      try {
        const result = await uploadPdfToDrive(blob, filename);
        document.body.removeChild(uploadingMsg);
        status.textContent = 'Upload successful';
        const linkDiv = document.getElementById('resultLink');
        const url = result.webViewLink || `https://drive.google.com/file/d/${result.id}/view`;
        linkDiv.innerHTML = `<a href="${url}" target="_blank">Open uploaded PDF in Google Drive</a>`;
        alert('Upload successful!');
      } catch (upErr) {
        document.body.removeChild(uploadingMsg);
        console.error('Upload failed:', upErr);
        status.textContent = 'Upload failed — PDF downloaded locally';
        alert('Upload failed; the PDF will be downloaded instead. Error: ' + (upErr.message || JSON.stringify(upErr)));
        pdf.save(filename);
      }

    } catch (err) {
      console.error('PDF generation failed', err);
      status.textContent = 'Error: ' + (err.message || err);
      alert('PDF generation failed: ' + (err.message || err));
    }
  }

  function resetForm() {
    if (!confirm('Clear all fields?')) return;
    document.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], textarea').forEach(i => i.value = '');
    document.getElementById('status').textContent = 'Ready';
    document.getElementById('resultLink').innerHTML = '';
  }
</script>
</body>
</html>
