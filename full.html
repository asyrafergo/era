<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ergonomics Risk Assessment - Full 8 Pages</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <!-- jsPDF and AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .form-page { display: none; }
        .form-page.active { display: block; }
        .nav-btn { margin: 20px 10px 0 0; padding: 10px 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: center; vertical-align: middle; }
        th { background-color: #f2f2f2; }
        input[type="file"] { margin-top: 5px; }
        .remove-btn { background-color: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 10px; margin-top: 5px; }
        .remove-btn:hover { background-color: #c82333; }
        .logo img {display: block; margin: 10px auto; width: 400px; /* Increase this value as needed */ height: auto;
}
    </style>
</head>
<body>
<div id="formContainer">
    <!-- PAGE 1 nice -->
    <div class="form-page active" id="page0">
        <h2 style="text-align:center;">INITIAL ERGONOMICS RISK ASSESSMENT CHECKLIST</h2>
        <form id="form1">
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 10px;"><label>Assessor:</label></td>
              <td style="padding: 10px;" colspan="3"><input type="text" id="assessor" required style="width: 100%;"></td>
            </tr>
            <tr>
              <td style="padding: 10px;"><label>Date:</label></td>
              <td style="padding: 10px;"><input type="date" id="date" required></td>
              <td style="padding: 10px;"><label>Department:</label></td>
              <td style="padding: 10px;"><input type="text" id="department" required></td>
            </tr>
            <tr>
              <td style="padding: 10px;"><label>Task Description:</label></td>
              <td style="padding: 10px;" colspan="3">
                <textarea id="taskDescription" required placeholder="Provide a detailed task description..." style="width: 100%; height: 100px;"></textarea>
              </td>
            </tr>
          </table>
      
          <div id="photoContainer"></div>
          <button type="button" class="nav-btn" onclick="addPhotoSection()">Add Photo & Description</button>      
        </form>
        <button type="button" class="nav-btn" onclick="nextPage()">Next</button>
    </div>

    <!-- PAGE 2 nice -->
    <div class="form-page" id="page1">
        <h2 style="text-align:center;">ERGONOMICS RISK FACTORS: AWKWARD POSTURE</h2>
        <form id="form2">
            <table>
                <thead>
                    <tr>
                        <th>Body Part</th>
                        <th>Risk Factor</th>
                        <th>Exposure Duration</th>
                        <th>Yes</th>
                        <th>No</th>
                        <th>Remarks/Photo</th>
                    </tr>
                </thead>
                <tbody id="formBody"></tbody>
            </table>
        </form>
        <button type="button" class="nav-btn" onclick="prevPage()">Back</button>
        <button type="button" class="nav-btn" onclick="nextPage()">Next</button>
    </div>

        <!-- PAGE 3 -->
        <div class="form-page" id="page2">
          <h2 style="text-align:center;">Ergonomics Risk Factors: Repetitive Motion</h2>
          <form id="form3">
            <div class="section-title">ERGONOMICS RISK FACTORS: STATIC AND SUSTAINED WORK POSTURE</div>
            <table>
              <thead>
                <tr>
                  <th>Body Part</th>
                  <th>Physical Risk Factor</th>
                  <th>Max. Exposure Duration</th>
                  <th>Yes</th>
                  <th>No</th>
                  <th>Remarks / Photos</th>
                </tr>
              </thead>
              <tbody id="staticPostureTable3"></tbody>
            </table>
          
            <div class="section-title">ERGONOMICS RISK FACTORS: FORCEFUL EXERTION (MANUAL HANDLING)</div>
            <div style="font-size: 16px; margin-top: 8px; text-align: center;">
              <strong>Ergonomics Risk Factors: Forceful Exertion</strong>
            </div>
            <div style="font-size: 16px; margin-bottom: 12px; text-align: center;">
              <strong>(Manual handling – Lifting and/or lowering)</strong>
            </div> 
            <div class="logo">
                      <img src="Figure_1.png" alt="Figure">
            </div>
            <table>
              <thead>
                <tr>
                  <th>Working Height</th>
                  <th>Recommended Weight</th>
                  <th>Current Weight</th>
                  <th>Exceed Limit?</th>
                  <th>Remarks / Photos</th>
                </tr>
              </thead>
              <tbody id="manualHandlingTable3"></tbody>
            </table>          
          </form>
          <button type="button" class="nav-btn" onclick="prevPage()">Back</button>
          <button type="button" class="nav-btn" onclick="nextPage()">Next</button>
      </div>

    <!-- PAGE 4  nice--> 
    <div class="form-page" id="page3">
      <h3 style="text-align:center;">Ergonomics Risk Factors: Forceful Exertion<br>(Manual handling – Repetitive handling)</h3>
      <table>
          <tr>
              <th>If employee repeats operations</th>
              <th>Weight* should be reduced by</th>
          </tr>
          <tr>
              <td>Once or twice per minute</td>
              <td>30%</td>
          </tr>
          <tr>
              <td>Five to eight times per minute</td>
              <td>50%</td>
          </tr>
          <tr>
              <td>More than 12 times per minute</td>
              <td>80%</td>
          </tr>
      </table>
      <h3 style="text-align:center;">Ergonomics Risk Factors: Forceful Exertion<br>(Manual handling – Lifting and lowering with twisted body posture)</h3>
      <table>
          <tr>
              <th>If employee twists body from forward facing to the side</th>
              <th>Weight* should be reduced by</th>
          </tr>
          <tr>
              <td>45 degrees</td>
              <td>10%</td>
          </tr>
          <tr>
              <td>90 degrees</td>
              <td>20%</td>
          </tr>
      </table>
      <h3 style="text-align:center;">Ergonomics Risk Factors: Forceful Exertion (Pushing and/or <u>Pulling</u>)</h3>
      <table>
          <tr>
              <th rowspan="2">Activity</th>
              <th colspan="2">Recommended weight</th>
          </tr>
          <tr>
              <th>Male</th>
              <th>Female</th>
          </tr>
          <tr>
              <td>Stopping or starting a load</td>
              <td>approximately 1000 kg load (equivalent to 200N pushing or pulling force) on smooth level surface using well maintained handling aid</td>
              <td>approximately 750 kg load (equivalent to 150N pushing or pulling force) on smooth level surface using well maintained handling aid</td>
          </tr>
          <tr>
              <td>Keeping the load in motion</td>
              <td>approximately 100 kg load (equivalent to 100N pushing or pulling force) on uneven level surface using well maintained handling aid</td>
              <td>approximately 70 kg load (equivalent to 70N pushing or pulling force) on uneven level surface using well maintained handling aid</td>
          </tr>
      </table>
      <button type="button" class="nav-btn" onclick="prevPage()">Back</button>
      <button type="button" class="nav-btn" onclick="nextPage()">Next</button>
  </div>

    <!-- PAGE new 5 not nice -->
    <div class="form-page" id="page4">
      <h2 style="text-align:center;">Ergonomics Risk Factors: Contact Stress</h2>
      <form id="form5">
        <h3>(Handling in Seated Position)</h3>
        <div class="logo">
                  <img src="Figure_2.png" alt="Figure">
        </div>
        <h3>Summary of Carrying Activity</h3>

        <table id="carryingTable">
          <thead>
            <tr>
              <th>Factor</th>
              <th>Condition</th>
              <th>Outcome</th>
              <th>Remarks or photos</th>
              <th class="no-print">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Floor Surface</td>
              <td>Dry and clean floor in good condition</td>
              <td>Acceptable</td>
              <td><input type="text" placeholder="Remarks" class="remark-input">
                  <input type="file" accept="image/*" onchange="previewImage5(this)">
                  <img class="preview"></td>
              <td class="no-print"></td>
            </tr>
            <tr>
              <td>Floor Surface</td>
              <td>Dry floor but in poor condition, worn or uneven</td>
              <td>Conduct advanced ERA</td>
              <td><input type="text" placeholder="Remarks" class="remark-input">
                  <input type="file" accept="image/*" onchange="previewImage5(this)">
                  <img class="preview"></td>
              <td class="no-print"></td>
            </tr>
            <tr>
              <td>Floor Surface</td>
              <td>Contaminated/wet or steep sloping floor or unstable surface or unsuitable footwear</td>
              <td>Conduct advanced ERA</td>
              <td><input type="text" placeholder="Remarks" class="remark-input">
                  <input type="file" accept="image/*" onchange="previewImage5(this)">
                  <img class="preview"></td>
              <td class="no-print"></td>
            </tr>
            <tr>
              <td>Other environmental factors</td>
              <td>No factors present</td>
              <td>Acceptable</td>
              <td><input type="text" placeholder="Remarks" class="remark-input">
                  <input type="file" accept="image/*" onchange="previewImage5(this)">
                  <img class="preview"></td>
              <td class="no-print"></td>
            </tr>
            <tr>
              <td>Other environmental factors</td>
              <td>One or more factors present (i.e. poor lighting condition and strong air movements)</td>
              <td>Conduct advanced ERA</td>
              <td><input type="text" placeholder="Remarks" class="remark-input">
                  <input type="file" accept="image/*" onchange="previewImage5(this)">
                  <img class="preview"></td>
              <td class="no-print"></td>
            </tr>
            <tr>
              <td>Carry distance</td>
              <td>2 m—10 m</td>
              <td>Acceptable</td>
              <td><input type="text" placeholder="Remarks" class="remark-input">
                  <input type="file" accept="image/*" onchange="previewImage5(this)">
                  <img class="preview"></td>
              <td class="no-print"></td>
            </tr>
            <tr>
              <td>Carry distance</td>
              <td>10 m or more</td>
              <td>Conduct advanced ERA</td>
              <td><input type="text" placeholder="Remarks" class="remark-input">
                  <input type="file" accept="image/*" onchange="previewImage5(this)">
                  <img class="preview"></td>
              <td class="no-print"></td>
            </tr>
            <tr>
              <td>Obstacles en route</td>
              <td>No obstacles and carry route is flat</td>
              <td>Acceptable</td>
              <td><input type="text" placeholder="Remarks" class="remark-input">
                  <input type="file" accept="image/*" onchange="previewImage5(this)">
                  <img class="preview"></td>
              <td class="no-print"></td>
            </tr>
            <tr>
              <td>Obstacles en route</td>
              <td>Steep slope or up steps or through closed doors or trip hazards or using ladders</td>
              <td>Conduct advanced ERA</td>
              <td><input type="text" placeholder="Remarks" class="remark-input">
                  <input type="file" accept="image/*" onchange="previewImage5(this)">
                  <img class="preview"></td>
              <td class="no-print"></td>
            </tr>
          </tbody>
        </table>
        
          <button type="button" onclick="addOtherRow5()">Add 'Others' Row</button>

      </form>
      <button type="button" class="nav-btn" onclick="prevPage()">Back</button>
      <button type="button" class="nav-btn" onclick="nextPage()">Next</button>
  </div>

    <!-- PAGE 6 nice -->
    <div class="form-page" id="page5">
      <h2 style="text-align:center;">Summary of Forceful Exertion (Manual Handling)</h2>
      <form id="form6">
          <table>
              <thead>
                  <tr>
                      <th>Activity</th>
                      <th>Recommended Weight</th>
                      <th style="width: 120px;">Exceed Limit?</th>
                      <th>Remarks / Photos</th>
                  </tr>
              </thead>
              <tbody id="manualHandlingTable"></tbody>
          </table>
      </form>
      <button type="button" class="nav-btn" onclick="prevPage()">Back</button>
      <button type="button" class="nav-btn" onclick="nextPage()">Next</button>
  </div>

    <!-- PAGE 7 nice -->
    <div class="form-page" id="page6">
        <h2 style="text-align:center;">ERGONOMICS RISK FACTORS: REPETITIVE MOTION</h2>
        <form id="form7">
          <table>
            <thead>
              <tr>
                <th>Body Part</th>
                <th>Physical Risk Factor</th>
                <th>Max. Exposure Duration</th>
                <th>Yes</th>
                <th>No</th>
                <th>Remarks / Photos</th>
              </tr>
            </thead>
            <tbody id="MotionTable"></tbody>
          </table>
        
          <h2 style="text-align:center;">ERGONOMICS RISK FACTORS: VIBRATION</h2>
          <table>
            <thead>
              <tr>
                <th>Body Part</th>
                <th>Physical Risk Factor</th>
                <th>Max. Exposure Duration</th>
                <th>Yes</th>
                <th>No</th>
                <th>Remarks / Photos</th>
              </tr>
            </thead>
            <tbody id="VibrationTable"></tbody>
          </table>
        </form>
        <button type="button" class="nav-btn" onclick="prevPage()">Back</button>
        <button type="button" class="nav-btn" onclick="nextPage()">Next</button>
    </div>

    <!-- PAGE 8 nice -->
    <div class="form-page" id="page7">
        <h2 style="text-align:center;">Summary  & Final Comments</h2>
        <form id="form8">
          <table>
            <thead>
              <tr>
                <th>Body Part</th>
                <th>Yes</th>
                <th>No</th>
                <th>Remarks / Photos</th>
              </tr>
            </thead>
            <tbody id="staticPostureTable"></tbody>
          </table>

          <h2>Initial ERA Form</h2>
<table id="eraTable">
  <thead>
    <tr>
      <th>Risk Factor</th>
      <th>Total score</th>
      <th>Minimum Requirements for Advance ERA</th>
      <th class="col-D" style="width: 250px;">Result of Initial ERA</th>
      <th class="col-E">Any pain or discomfort due to risk factors as found in MSD assessment Refer Part 3.1 (Yes/No)<br></th>
      <th class="col-F">Need advanced ERA (Yes/No) </th>
    </tr>
  </thead>
  <tbody>
    <tr>
        <td style="text-align: center;">Awkward posture</td><td style="text-align: center;">13</td><td style="text-align: center;">≥ 6</td><td class="col-D"><input type="number" name="result[]" min="0" style="width: 100%; border: none; text-align: center;"></td><td class="col-E" rowspan="9">
            <div class="checkbox-list">
              If YES please tick which part of body:<br>
              <label><input type="checkbox" name="body" value="Neck"> Neck</label><br>
              <label><input type="checkbox" name="body" value="Shoulder"> Shoulder</label><br>
              <label><input type="checkbox" name="body" value="Upper back"> Upper back</label><br>
              <label><input type="checkbox" name="body" value="Lower back"> Lower back</label><br>
              <label><input type="checkbox" name="body" value="Upper arm"> Upper arm</label><br>
              <label><input type="checkbox" name="body" value="Elbow"> Elbow</label><br>
              <label><input type="checkbox" name="body" value="Lower Arm"> Lower Arm</label><br>
              <label><input type="checkbox" name="body" value="Hand/Wrist"> Hand/Wrist</label><br>
              <label><input type="checkbox" name="body" value="Thigh"> Thigh</label><br>
              <label><input type="checkbox" name="body" value="Knee"> Knee</label><br>
              <label><input type="checkbox" name="body" value="Lower leg"> Lower leg</label><br>
              <label><input type="checkbox" name="body" value="Ankle/Foot"> Ankle/Foot</label>
            </div>
          </td></td><td class="col-F"></td>
    </tr>
    <tr>
        <td style="text-align: center;">Static and sustained work posture</td><td style="text-align: center;">3</td><td style="text-align: center;">≥ 1</td><td class="col-D"><input type="number" name="result[]" min="0" style="width: 100%; border: none; text-align: center;"></td><td class="col-F"></td>
    </tr>
    <tr>
        <td style="text-align: center;">Forceful exertion</td>
      <td style="text-align: center;">1</td>
      <td style="text-align: center;">1</td>
      <td class="col-D">
        <div class="checkbox-list">
            <label>Lifting/Lowering: <input type="number" name="action" data-label="Lifting/Lowering" min="0" style="width: 60px;"></label><br>
            <label>Pushing/Pulling: <input type="number" name="action" data-label="Pushing/Pulling" min="0" style="width: 60px;"></label><br>
            <label>Handling Load in Seated: <input type="number" name="action" data-label="Handling Load in Seated" min="0" style="width: 60px;"></label><br>
            <label>Carrying: <input type="number" name="action" data-label="Carrying" min="0" style="width: 60px;"></label><br>
            <label>Other: <input type="number" name="action" data-label="Other" min="0" style="width: 60px;"></label>
          </div>          
      </td>
      <td class="col-F"></td>
    </tr>
    <tr><td style="text-align: center;">Repetition</td><td style="text-align: center;">5</td><td style="text-align: center;">≥ 1</td><td class="col-D"><input type="number" name="result[]" min="0" style="width: 100%; border: none; text-align: center;"></td><td class="col-F"></td></tr>
    <tr><td style="text-align: center;">Vibration</td><td style="text-align: center;">4</td><td style="text-align: center;">≥ 1</td><td class="col-D"><input type="number" name="result[]" min="0" style="width: 100%; border: none; text-align: center;"></td><td class="col-F"></td></tr>
    <tr><td style="text-align: center;">Lighting</td><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td class="col-D"><input type="number" name="result[]" min="0" style="width: 100%; border: none; text-align: center;"></td><td class="col-F"></td></tr>
    <tr><td style="text-align: center;">Temperature</td><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td class="col-D"><input type="number" name="result[]" min="0" style="width: 100%; border: none; text-align: center;"></td><td class="col-F"></td></tr>
    <tr><td style="text-align: center;">Ventilation</td><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td class="col-D"><input type="number" name="result[]" min="0" style="width: 100%; border: none; text-align: center;"></td><td class="col-F"></td></tr>
    <tr><td style="text-align: center;">Noise</td><td style="text-align: center;">2</td><td style="text-align: center;">≥ 1</td><td class="col-D"><input type="number" name="result[]" min="0" style="width: 100%; border: none; text-align: center;"></td><td class="col-F"></td></tr>
  </tbody>
</table>
        </form>
        <button type="button" class="nav-btn" onclick="prevPage()">Back</button>
        <button type="button" class="nav-btn" onclick="generateAllPDF()">Generate All PDF</button>
    </div>
</div>

<script>
    // Navigation logic
    let currentPage = 0;
    const totalPages = 8;
    function showPage(index) {
        document.querySelectorAll('.form-page').forEach((div, i) => {
            div.classList.toggle('active', i === index);
        });
        currentPage = index;
    }
    function nextPage() {
        if (currentPage < totalPages - 1) showPage(currentPage + 1);
    }
    function prevPage() {
        if (currentPage > 0) showPage(currentPage - 1);
    }

    // PAGE 1: Photo logic
    function addPhotoSection() {
        const container = document.getElementById('photoContainer');
        const index = container.children.length;
        const group = document.createElement('div');
        group.classList.add('photo-group');
        group.innerHTML = `
            <label>Photo: <input type="file" id="photo${index}" accept="image/*" onchange="previewImage(this, 'preview${index}')"></label>
            <img id="preview${index}" src="" style="max-width: 200px; max-height: 150px; display: none; margin-top: 10px;" />
            <label>Description:<br>
                <textarea id="photoDescription${index}" placeholder="Describe the uploaded photo..."></textarea>
            </label>
            <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Remove</button>
        `;
        container.appendChild(group);
    }
    window.previewImage = function(input, previewId) {
        const file = input.files[0];
        const preview = document.getElementById(previewId);
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = "block";
            };
            reader.readAsDataURL(file);
        } else {
            preview.src = "";
            preview.style.display = "none";
        }
    };

    // PAGE 2: Awkward posture questions
    const questions = [
        { part: "Shoulders", factor: "Work with hand above the head OR the elbow above the shoulder", duration: "More than 2 hours per day" },
        { part: "Shoulders", factor: "Work with shoulder raised", duration: "More than 2 hours per day" },
        { part: "Shoulders", factor: "Work repetitively by raising the hand above the head OR the elbow above the shoulder more than once per minute", duration: "More than 2 hours per day" },
        { part: "Head", factor: "Work with head bent downwards more than 45 degrees", duration: "More than 2 hours per day" },
        { part: "Head", factor: "Work with head bent backwards", duration: "More than 2 hours per day" },
        { part: "Head", factor: "Work with head bent sideways", duration: "More than 2 hours per day" },
        { part: "Back", factor: "Work with back bent forward more than 30 degrees OR bent sideways", duration: "More than 2 hours per day" },
        { part: "Back", factor: "Work with body twisted", duration: "More than 2 hours per day" },
        { part: "Hand/ Elbow/ Wrist", factor: "Work with wrist flexion OR extension OR radial deviation more than 15 degrees", duration: "More than 2 hours per day" },
        { part: "Hand/ Elbow/ Wrist", factor: "Work with arm abduction sideways", duration: "More than 4 hours per day" },
        { part: "Hand/ Elbow/ Wrist", factor: "Work with arm forward more than 45 degrees OR arm backward more than 20 degrees", duration: "More than 2 hours per day" },
        { part: "Leg/ Knees", factor: "Work in a squat position", duration: "More than 2 hours per day" },
        { part: "Leg/ Knees", factor: "Work in a kneeling position", duration: "More than 2 hours per day" }
    ];
    const formBody = document.getElementById('formBody');
    questions.forEach((q, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${q.part}</td>
            <td>${q.factor}</td>
            <td>${q.duration}</td>
            <td><input type="radio" name="q${index}" value="Yes"></td>
            <td><input type="radio" name="q${index}" value="No"></td>
            <td>
                <input type="text" placeholder="Remarks" id="remark${index}">
                <input type="file" accept="image/*" id="file${index}" onchange="previewImagePage2(event, 'preview${index}')">
                <div id="preview${index}b" style="margin-top:5px;"></div>
            </td>
        `;
        formBody.appendChild(row);
    });

    function previewImagePage2(event, id) {
  const file = event.target.files[0];
  const previewDiv = document.getElementById(`${id}b`);
  if (file && file.type.startsWith("image/")) {
    const reader = new FileReader();
    reader.onload = function(e) {
      previewDiv.innerHTML = `<img src="${e.target.result}" style="max-width: 100px; max-height: 100px;">`;
    };
    reader.readAsDataURL(file);
  } else {
    previewDiv.innerHTML = `<p style="color:red;">Invalid image</p>`;
  }
}


    // PAGE 3 
    const staticData3 = [
    {
      part: "Trunk/Head/Neck/Arm/Wrist",
      factor: "Work in a static awkward position as in Table 1",
      duration: "Refer Table 1"
    },
    {
      part: "Leg/Knees",
      factor: "Standing with minimal leg movement",
      duration: "More than 2 hours"
    },
    {
      part: "Leg/Knees",
      factor: "Seated with minimal movement",
      duration: "More than 30 mins"
    }
  ];

  const manualData3 = [
    { height: "Floor to mid-lower leg"},
    { height: "Mid-lower leg to knuckle"},
    { height: "Knuckle to elbow" },
    { height: "Elbow to shoulder"},
    { height: "Above shoulder"}
  ];

  const staticTable3 = document.getElementById("staticPostureTable3");
  staticData3.forEach((row, i) => {
    staticTable3.innerHTML += `
      <tr>
        <td>${row.part}</td>
        <td>${row.factor}</td>
        <td>${row.duration}</td>
        <td><input type="radio" name="sp${i}" value="Yes"></td>
        <td><input type="radio" name="sp${i}" value="No"></td>
        <td>
          <input type="text" placeholder="Remarks" id="spr${i}">
          <input type="file" accept="image/*" id="spf${i}" onchange="previewImage(event, 'preview_spf${i}')">
<div id="preview_spf${i}" style="margin-top:5px;"></div>
        </td>
      </tr>
    `;
  });

  const manualTable3 = document.getElementById("manualHandlingTable3");
  manualData3.forEach((row, i) => {
    manualTable3.innerHTML += `
      <tr>
        <td>${row.height}</td>
        <td>
            <div style="text-align: center;">
    <label><input type="radio" name="gender${i}" value="Male"> Male</label>
    <label><input type="radio" name="gender${i}" value="Female"> Female</label>
    </div>
  </td>
        <td><input type="text" id="mhWeight${i}"></td>
        <td>
          <input type="radio" name="mh3${i}" value="Yes"> Yes
          <input type="radio" name="mh3${i}" value="No"> No
        </td>
        <td>
          <input type="text" placeholder="Remarks" id="mhr${i}">
          <input type="file" accept="image/*" id="mhf${i}" onchange="previewImage(event, 'mhf${i}')"><br>
          <div id="preview_mhf${i}" style="margin-top:5px;"></div>
        </td>
      </tr>
    `;
  });

  function previewImage(event, id) {
    const file = event.target.files[0];
    const previewId = `preview_${id}`;
    const previewDiv = document.getElementById(previewId);

    if (file && file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewDiv.innerHTML = `
                <img src="${e.target.result}" 
                     alt="Preview" 
                     style="max-width: 100px; max-height: 100px; margin-top: 5px; border: 1px solid #ccc;">
            `;
        };
        reader.readAsDataURL(file);
    } else {
        previewDiv.innerHTML = `<p style="color:red;">Invalid image file</p>`;
    }
}

    // PAGE 5 New not click 
  
  function addOtherRow5() {
  const table = document.getElementById('carryingTable').getElementsByTagName('tbody')[0];

  const newRow = document.createElement('tr');
  newRow.innerHTML = `
    <td>Others</td>
    <td><input type="text" placeholder="Condition"></td>
    <td><input type="text" placeholder="Outcome"></td>
    <td>
      <input type="text" placeholder="Remarks" class="remark-input">
      <input type="file" accept="image/*" onchange="previewImage5(this)">
      <img class="preview">
    </td>
    <td class="no-print"><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
  `;
  table.appendChild(newRow);
}

function deleteRow(button) {
  const row = button.closest('tr');
  row.remove();
}

    // PAGE 6: Manual Handling Table  nice 
    const manualData = [
        { activity: "Lifting and lowering; or", rweight: "Figure 3.1 & Table 3.3"},
        { activity: "Repetitive lifting and lowering; or", rweight: "Figure 3.1 & Table 3.4"},
        { activity: "Twisted body posture while lifting and lowering; or", rweight: "Figure 3.1 & Table 3.5" },
        { activity: "Repetitive lifting and lowering with twisted body posture; or", rweight: "based on Figure 3.1, Table 3.4 and Table 3.5"},
        { activity: "Pushing and Pulling; or", rweight: "based on Table 3.6" },
        { activity: "Handling in seated position; or", rweight: "based on Figure 3.2" },
        { activity: "Carrying", rweight: "based on Table 3.7" },
        { activity: "Other Forceful Activity", rweight: "" }
    ];
    const manualTable = document.getElementById("manualHandlingTable");
    manualData.forEach((row, i) => {
        manualTable.innerHTML += `
            <tr>
                <td>${row.activity}</td>
                <td>${row.rweight}</td>
                <td>
                    <input type="radio" name="mh${i}" value="Yes"> Yes
                    <input type="radio" name="mh${i}" value="No"> No
                </td>
                <td>
                    <input type="text" placeholder="Remarks" id="mhr${i}"><br>
                    <input type="file" accept="image/*" id="mhf${i}" onchange="previewImage(event, 'preview-mhf${i}')"><br>
                    <img id="preview-mhf${i}" src="" style="max-width: 80px; max-height: 80px; margin-top: 5px;">
                </td>
            </tr>
        `;
    });

    // PAGE 7: Vibration click
    const MotionData = [
    {
      part: "Neck,shoulders,elbows,wrists, hands, knee",
      factor: "Work involving repetitive sequence of movement more than twice per minute",
      duration: "More than 3 hours on a “normal” workday OR More than 1 hour continuously without a break"
    },
    {
      part: "Neck,shoulders,elbows,wrists, hands, knee",
      factor: "Work involving intensive use of the fingers, hands or wrist or work involving intensive data entry (key-in)",
      duration: "More than 3 hours on a “normal” workday OR More than 1 hour continuously without a break"
    },
    {
      part: "Neck,shoulders,elbows,wrists, hands, knee",
      factor: "Work involving repetitive shoulder/arm movement with some pauses OR continuous shoulder/arm movement",
      duration: "More than 3 hours on a “normal” workday OR More than 1 hour continuously without a break"
    },
    {
      part: "Neck,shoulders,elbows,wrists, hands, knee",
      factor: "Work using the heel/base of palm as a “hammer” more than once per minute",
      duration: "More than 2 hours per day"
    },
    {
      part: "Neck,shoulders,elbows,wrists, hands, knee",
      factor: "Work using the knee as a “hammer” more than once per minute",
      duration: "More than 2 hours per day"
    }
  ];

  const VibrationData = [
  {
      part: "Hand-Arm (segmental vibration)",
      factor: "Work using power tools (e.g. battery powered/ electrical pneumatic/ hydraulic) without PPE",
      duration: "More than 50 minutes in an hour"
    },
    {
      part: "Hand-Arm (segmental vibration)",
      factor: "Work using power tools (e.g. battery powered/ electrical pneumatic/ hydraulic) with PPE",
      duration: "More than 5 hours in 8 hours shift work"
    },
    {
      part: "Whole body",
      factor: "Work involving exposure to whole body vibration",
      duration: "More than 5 hours in 8 hours shift work"
    },
    {
      part: "Whole body",
      factor: "Work involving exposure to whole body vibration combined employee complaint of excessive body shaking",
      duration: "More than 3 hours in 8 hours shift work"
    }
  ];
  const MotionTable = document.getElementById("MotionTable");
MotionData.forEach((row, i) => {
  MotionTable.innerHTML += `
    <tr>
      <td>${row.part}</td>
      <td>${row.factor}</td>
      <td>${row.duration}</td>
      <td><input type="radio" name="motion${i}" value="Yes"></td>
      <td><input type="radio" name="motion${i}" value="No"></td>
      <td>
      <input type="text" placeholder="Remarks" id="remarkPhoto${i}">
      <input type="file" accept="image/*" id="remarkPhoto${i}File" onchange="previewImage(this, 'preview${i}')">
      <br>
      <img id="preview${i}" style="max-width: 80px; max-height: 80px; margin-top: 5px;" />
    </td>
    </tr>
  `;
});

const VibrationTable = document.getElementById("VibrationTable");
VibrationData.forEach((row, i) => {
  const index = i + MotionData.length;
  VibrationTable.innerHTML += `
    <tr>
      <td>${row.part}</td>
      <td>${row.factor}</td>
      <td>${row.duration}</td>
      <td><input type="radio" name="vibration${i}" value="Yes"></td>
      <td><input type="radio" name="vibration${i}" value="No"></td>
      <td>
      <input type="text" placeholder="Remarks" id="remarkPhoto${index}">
      <input type="file" accept="image/*" id="remarkPhoto${index}File" onchange="previewImage(this, 'preview${index}')">
      <br>
      <img id="preview${index}" style="max-width: 80px; max-height: 80px; margin-top: 5px;" />
    </td>
    </tr>
  `;
});

function previewImage(fileInput, previewId) {
  const file = fileInput.files[0];
  const preview = document.getElementById(previewId);

  if (file && file.type.startsWith("image/")) {
    const reader = new FileReader();
    reader.onload = function(e) {
      preview.src = e.target.result;
    };
    reader.readAsDataURL(file);
  } else {
    preview.src = "";
  }
}

    // PAGE 8: Finalley click
    const staticData = [
    {
      part: "Inadequate lighting"
    },
    {
      part: "Extreme temperature (hot/cold)"
    },
    {
      part: "Inadequate air ventilation or poor IAQ"
    },
    {
      part: "Noise exposure above PEL"
    },
    {
      part: "Exposed to annoying noise more than 8 hours"
    }
  ];

  const staticTable = document.getElementById("staticPostureTable");
  staticData.forEach((row, i) => {
    staticTable.innerHTML += `
      <tr>
        <td>${row.part}</td>
        <td><input type="radio" name="sp${i}" value="Yes"></td>
        <td><input type="radio" name="sp${i}" value="No"></td>
        <td>
          <input type="text" placeholder="Remarks" id="spr${i}">
          <input type="file" accept="image/*" id="spf${i}" onchange="previewImage(event, ${i})">
          <br>
          <img id="imagePreview${i}" style="max-width: 100px; max-height: 100px; display: none;" />
        </td>
      </tr>
    `;
  });

document.querySelectorAll('.yes, .no').forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
      const group = this.getAttribute('data-group');
      const type = this.classList.contains('yes') ? 'yes' : 'no';

      // If this is checked, uncheck the opposite
      if (this.checked) {
        const oppositeClass = type === 'yes' ? 'no' : 'yes';
        const opposite = document.querySelector(`.${oppositeClass}[data-group="${group}"]`);
        if (opposite) {
          opposite.checked = false;
        }
      }
    });
  });

    // PDF GENERATION
    async function generateAllPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

        function toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        })};

        // --- PAGE 1 --- click
        doc.setFontSize(14);
        doc.text("PAGE 1 : INITIAL ERGONOMICS RISK ASSESSMENT CHECKLIST", 105, 15, { align: "center" });
        const dateInput = document.getElementById("date").value;
        const formattedDate = dateInput ? new Date(dateInput).toLocaleDateString('en-GB').replace(/\//g, ' ') : '';
        const tableData1 = [
            [
                { content: "Assessor", styles: { fontStyle: 'bold', fillColor: [200, 200, 200] } },
                { content: document.getElementById("assessor").value, colSpan: 2 },
                { content: "Date", styles: { fontStyle: 'bold', fillColor: [200, 200, 200]} },
                { content: formattedDate }
            ],
            [
                { content: "Department", styles: { fontStyle: 'bold', fillColor: [200, 200, 200]} },
                { content: document.getElementById("department").value, colSpan: 4 }
            ],
            [
                { content: "Task Description", styles: { fontStyle: 'bold', fillColor: [200, 200, 200]} },
                { content: document.getElementById("taskDescription").value, colSpan: 4 }
            ]
        ];
        const groups = document.querySelectorAll('.photo-group');
        const imagesData = [];
        for (let i = 0; i < groups.length; i++) {
            const desc = document.getElementById(`photoDescription${i}`)?.value || '';
            const fileInput = document.getElementById(`photo${i}`);
            const file = fileInput?.files[0];
            let imgData = null;
            if (file) imgData = await toBase64(file);
            imagesData.push({ desc, imgData, label: i === 0 ? "Photos and Descriptions" : "" });
        }
        imagesData.forEach((item) => {
            tableData1.push([
                { content: item.label, styles: { fontStyle: 'bold', fillColor: [200, 200, 200] } },
                { content: '', colSpan: 2, styles: { minCellHeight: 40 } },
                { content: item.desc, colSpan: 2 }
            ]);
        });
        doc.autoTable({
            startY: 25,
            body: tableData1,
            theme: 'grid',
            styles: { fontSize: 10 },
            columnStyles: { 0: { cellWidth: 30 }, 1: { cellWidth: 50 }, 2: { cellWidth: 10 }, 3: { cellWidth: 40 }, 4: { cellWidth: 40 } },
            didParseCell: function (data) {
                const imageIndex = data.row.index - 3;
                if (data.column.index === 1 && imagesData[imageIndex]?.imgData) {
                    const img = imagesData[imageIndex].imgData;
                    const baseWidth = 60;
                    const maxHeight = 70;
                    let imgHeight = 40;
                    const approxLineHeight = 4.5;
                    const lines = Math.ceil((imgHeight + 4) / approxLineHeight);
                    data.cell.text = Array(lines).fill('\n');
                }
            },
            didDrawCell: function (data) {
                const imageIndex = data.row.index - 3;
                if (data.column.index === 1 && imagesData[imageIndex]?.imgData) {
                    const img = imagesData[imageIndex].imgData;
                    const maxWidth = data.cell.width - 4;
                    const maxHeight = data.cell.height - 4;
                    let imgWidth = 60, imgHeight = 40;
                    const x = data.cell.x + (data.cell.width - imgWidth) / 2;
                    const y = data.cell.y + (data.cell.height - imgHeight) / 2;
                    const format = img.includes('image/png') ? 'PNG' : 'JPEG';
                    doc.addImage(img, format, x, y, imgWidth, imgHeight);
                }
            }
        });

        // --- PAGE 2 --- click
        doc.addPage();
        doc.setFontSize(14);
        doc.text('PAGE 2 : ERGONOMICS RISK FACTORS: AWKWARD POSTURE', 105, 15, { align: "center" });
        const rows2 = [];
        let totalYes2 = 0;
        const imageDataArray2 = [];

        for (let i = 0; i < questions.length; i++) {
    const yesInput = document.querySelector(`input[name='q${i}'][value='Yes']`);
    const noInput = document.querySelector(`input[name='q${i}'][value='No']`);

    const yesChecked = yesInput?.checked;
    const noChecked = noInput?.checked;

    let finalYes = yesChecked || false;
    let finalNo = noChecked || (!yesChecked && !noChecked); // assume No if both are unchecked

    if (finalYes) totalYes2++;

    const remark = finalYes ? (document.getElementById(`remark${i}`).value || '') : '';
    const fileInput = document.getElementById(`file${i}`);
    let maxImgWidth = 40;
    let maxImgHeight = 40;

        // Only process image if "Yes" is selected
    if (finalYes && fileInput.files[0]) {
        try {
            const file = fileInput.files[0];

            if (file.size > 1024 * 1024) {
                console.warn(`Image ${file.name} too large. Skipped.`);
                rows2.push([
                    questions[i].part,
                    questions[i].factor,
                    questions[i].duration,
                    finalYes ? '/' : '',
                    finalNo ? '/' : '',
                    'Image too large to include.'
                ]);
            }

            const readerResult = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = (err) => reject(err);
                reader.readAsDataURL(file);
            });

            const img = new Image();
            img.src = readerResult;

            await new Promise((resolve, reject) => {
                img.onload = resolve;
                img.onerror = reject;
            });

            let imgWidth = img.width;
            let imgHeight = img.height;
            const aspectRatio = imgWidth / imgHeight;

            if (imgWidth > maxImgWidth) {
                imgWidth = maxImgWidth;
                imgHeight = imgWidth / aspectRatio;
            }
            if (imgHeight > maxImgHeight) {
                imgHeight = maxImgHeight;
                imgWidth = imgHeight * aspectRatio;
            }

            imageDataArray2.push({
                index: i,
                data: readerResult,
                width: imgWidth,
                height: imgHeight
            });

            rows2.push([
                questions[i].part,
                questions[i].factor,
                questions[i].duration,
                finalYes ? '/' : '',
                finalNo ? '/' : '',
                '' // Placeholder for image
            ]);
        } catch (error) {
            console.error(`Error processing image for row ${i}:`, error);
            rows2.push([
                questions[i].part,
                questions[i].factor,
                questions[i].duration,
                finalYes ? '/' : '',
                finalNo ? '/' : '',
                'Error loading image.'
            ]);
        }
    } else {
        rows2.push([
            questions[i].part,
            questions[i].factor,
            questions[i].duration,
            finalYes ? '/' : '',
            finalNo ? '/' : '',
            remark
        ]);
    }
  }

    doc.autoTable({
        head: [['Body Part', 'Physical Risk Factor', 'Max. Exposure Duration', 'Yes', 'No', 'Remarks or Photos']],
        body: rows2,
        startY: 20,
        rowPageBreak: 'avoid', // 👈 This prevents row splitting
        theme: 'grid',
        styles: {
            fontSize: 10,
            cellPadding: 3,
            valign: 'middle',
            align: 'center',
            overflow: 'linebreak'
        },
        headStyles: {
            fillColor: [120, 120, 120],
            textColor: [255, 255, 255],
            fontStyle: 'bold'
        },
        columnStyles: {
            0: { cellWidth: 28 },
            1: { cellWidth: 38 },
            2: { cellWidth: 28 },
            3: { cellWidth: 14 },
            4: { cellWidth: 14 },
            5: { cellWidth: 'auto' }
        },
        didParseCell: function (data) {
            if (data.section === 'body' && data.column.index === 5) {
                const image = imageDataArray2.find(img => img.index === data.row.index);
                if (image) {
                    // Inject blank lines to increase height
                    const lines = Math.ceil((image.height * 1.2) / 3); // tweak for size
                    data.cell.text = Array(lines).fill('\n'); // add blank lines
                }
            }
        },
        didDrawCell: function (data) {
            if (data.section === 'body' && data.column.index === 5) {
                const rowIndex = data.row.index;
                const image = imageDataArray2.find(img => img.index === rowIndex);

                if (image) {
                    const imgWidthMM = image.width * 1.2;
                    const imgHeightMM = image.height * 1.2;

                    const cellX = data.cell.x;
                    const cellY = data.cell.y;
                    const cellWidth = data.cell.width;
                    const cellHeight = data.cell.height;

                    const imgX = cellX + (cellWidth - imgWidthMM) / 2;
                    const imgY = cellY + (cellHeight - imgHeightMM) / 2;

                    const format = image.data.includes('image/png') ? 'PNG' : 'JPEG';
                    doc.addImage(image.data, format, imgX, imgY, imgWidthMM, imgHeightMM);
                }
            }
        }
    });

    doc.autoTable({
        body: [[`Sub Total (Number of tick(s)): ${totalYes2}`]],
        startY: doc.previousAutoTable.finalY + 10,
        styles: {
            fontSize: 12,
            fontStyle: 'bold'
        }
    });

        // --- PAGE 3: Repetitive ---
        await generatePage3(doc);

        // --- PAGE 4 ---  click
        doc.addPage();
        doc.setFontSize(14);
        doc.text('PAGE 4 : Ergonomics Risk Factors: Forceful Exertion', 105, 15, { align: "center" });
        doc.autoTable({
            startY: 25,
            head: [["If employee repeats operations", "Weight* should be reduced by"]],
            body: [
                ["Once or twice per minute", "30%"],
                ["Five to eight times per minute", "50%"],
                ["More than 12 times per minute", "80%"]
            ],
            theme: 'grid',
            styles: { fontSize: 10 }
        });
        doc.text('(Manual handling – Lifting and lowering with twisted body posture)', 105, doc.lastAutoTable.finalY + 10, { align: "center" });
        doc.autoTable({
            startY: doc.lastAutoTable.finalY + 15,
            head: [["If employee twists body from forward facing to the side", "Weight* should be reduced by"]],
            body: [
                ["45 degrees", "10%"],
                ["90 degrees", "20%"]
            ],
            theme: 'grid',
            styles: { fontSize: 10 }
        });
        doc.text('Ergonomics Risk Factors: Forceful Exertion (Pushing and/or Pulling)', 105, doc.lastAutoTable.finalY + 10, { align: "center" });
        doc.autoTable({
            startY: doc.lastAutoTable.finalY + 15,
            head: [
                ["Activity", { content: "Recommended weight", colSpan: 2 }]
            ],
            body: [
                ["", "Male", "Female"],
                [
                    "Stopping or starting a load",
                    "approximately 1000 kg load (equivalent to 200N pushing or pulling force) on smooth level surface using well maintained handling aid",
                    "approximately 750 kg load (equivalent to 150N pushing or pulling force) on smooth level surface using well maintained handling aid"
                ],
                [
                    "Keeping the load in motion",
                    "approximately 100 kg load (equivalent to 100N pushing or pulling force) on uneven level surface using well maintained handling aid",
                    "approximately 70 kg load (equivalent to 70N pushing or pulling force) on uneven level surface using well maintained handling aid"
                ]
            ],
            theme: 'grid',
            styles: { fontSize: 8 }
        });


        // --- PAGE 5 not click meh  ---
        doc.addPage();
   // 1. Add main titles
doc.setFontSize(14);
doc.text("PAGE 5 : Ergonomics Risk Factors: Forceful Exertion", 105, 15, { align: "center" });
doc.text("(Handling in Seated Position)", 105, 22, { align: "center" });

const imageDataArray5 = [];

 // Function to preview the image when uploaded
 function previewImage5(input) {
    const file = input.files[0]; // Get the uploaded file
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.src = e.target.result; // Set the image source to the file data

      // Find the preview image element
      const preview = input.nextElementSibling; // Get the <img> element next to the input field

      img.onload = function() {
        preview.src = img.src; // Set the image src to the loaded file
        preview.style.display = 'block'; // Show the preview image
      }
    };
    reader.readAsDataURL(file); // Read the file as a Data URL
  }

// Read image files
function readImages() {
  const files = document.querySelectorAll('#form5 input[type="file"]');
  const promises = [];
  imageDataArray5.length = 0;

  files.forEach((fileInput, index) => {
    const file = fileInput.files[0];
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    if (file) {
      const reader = new FileReader();
      const promise = new Promise((resolve) => {
        reader.onload = function (e) {
          const img = new Image();
          img.onload = function () {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            const dataUrl = canvas.toDataURL("image/jpeg", 1.0);
            imageDataArray5.push({
              index: `page5_${index}`,
              data: dataUrl,
              width: img.width / 10,
              height: img.height / 10
            });
            resolve();
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
      promises.push(promise);
    }
  });

  return Promise.all(promises);
}

// 2. Load image and wait until it's ready
const figureImage = new Image();
figureImage.src = 'Figure_2.png';
await new Promise(resolve => figureImage.onload = resolve);

// 3. Scale and center the image
const scaledWidth = 100;
const scaleRatio = scaledWidth / figureImage.width;
const scaledHeight = figureImage.height * scaleRatio;

const figY = 30; // Y position after the title
const centerX = (doc.internal.pageSize.getWidth() - scaledWidth) / 2;

// 4. Add image
doc.addImage(figureImage, 'PNG', centerX, figY, scaledWidth, scaledHeight);

// 5. Add "Summary of Carrying Activity" heading BELOW image
const summaryY = figY + scaledHeight + 8;
doc.setFontSize(13);
doc.text("Summary of Carrying Activity", 105, summaryY, { align: "center" });
await readImages();
// 6. Set table start Y BELOW the heading
const tableStartY = summaryY + 6;

  const table = document.getElementById('carryingTable');
  const rows5 = table.querySelectorAll('tbody tr');

  const tableData = Array.from(rows5).map((row, rowIndex) => {
  const cells = row.querySelectorAll('td');

  const factor = cells[0] ? cells[0].innerText.trim() : "";
  const conditionInput = cells[1]?.querySelector('input[type="text"]');
  const condition = conditionInput ? conditionInput.value.trim() : cells[1]?.innerText.trim() || "";

  const outcomeInput = cells[2]?.querySelector('input[type="text"]');
  const outcome = outcomeInput ? outcomeInput.value.trim() : cells[2]?.innerText.trim() || "";

  const remarkInput = cells[3]?.querySelector('.remark-input');
  const remark = remarkInput ? remarkInput.value.trim() : "";

  return [factor, condition, outcome, remark, ""];
});

  doc.autoTable({
    head: [["Factor", "Condition", "Outcome", "Remarks/Photo"]],
    body: tableData,
    pageBreak: 'auto',
    startY: tableStartY,
    styles: { valign: 'middle', font: 'helvetica', fontSize: 10, halign: 'center'},
    columnStyles: {
      0: { cellWidth: 38 },   // Factor
      1: { cellWidth: 35 },   // Condition
      2: { cellWidth: 28 },   // Outcome
      3: { cellWidth: 'auto', halign: 'center'  },   // Remarks (text input)
    },
    didParseCell: function (data) {
  if (data.section === 'body' && data.column.index === 3) {
    const image = imageDataArray5.find(img => img.index === `page5_${data.row.index}`);
    if (image) {
      const scale = 1.4;
      const imgHeightMM = image.height * scale;
      const lineHeightMM = 4.5;
      const lines = Math.max(1, Math.ceil(Math.min(imgHeightMM, 40) / lineHeightMM));  // Cap space to avoid excessive gaps
      data.cell.text = Array(lines).fill('\n');
    } else {
      const text = data.cell.text?.toString().trim();
      if (!text) data.cell.text = "";
    }
  }
},

didDrawCell: function (data) {
  if (data.section === 'body' && data.column.index === 3) {
    const image = imageDataArray5.find(img => img.index === `page5_${data.row.index}`);
    if (image) {
      const maxWidthMM = data.cell.width * 0.9;
      const maxHeightMM = data.cell.height * 0.9;

      let imgWidthMM = image.width * 1.2;
      let imgHeightMM = image.height * 1.2;

      const scale = Math.min(maxWidthMM / imgWidthMM, maxHeightMM / imgHeightMM, 1);
      imgWidthMM *= scale;
      imgHeightMM *= scale;

      // Ensure minimum size
      imgWidthMM = Math.max(imgWidthMM, 20);
      imgHeightMM = Math.max(imgHeightMM, 20);

      const imgX = data.cell.x + (data.cell.width - imgWidthMM) / 2;
      const imgY = data.cell.y + (data.cell.height - imgHeightMM) / 2;

      const format = image.data.includes('image/png') ? 'PNG' : 'JPEG';
      doc.addImage(image.data, format, imgX, imgY, imgWidthMM, imgHeightMM);
    }
  }
}
  });

        // --- PAGE 6 click ---
        doc.addPage();
        doc.setFontSize(14);
        doc.text('Page 6 : Summary of Forceful Exertion (Manual Handling)', 105, 15, { align: "center" });
        const mhRows = [];
        const mhImageDataArray = [];
        let mhYesCount = 0;

        for (let i = 0; i < manualData.length; i++) {
    const yesRadio = document.querySelector(`input[name="mh${i}"][value="Yes"]`);
    const noRadio = document.querySelector(`input[name="mh${i}"][value="No"]`);
    const finalYes = yesRadio?.checked;
    const finalNo = noRadio?.checked;
    const remark = document.getElementById(`mhr${i}`).value;
    const file = document.getElementById(`mhf${i}`).files[0];

    const isYes = finalYes ? '/' : '';
    const isNo = finalNo || (!finalYes && !finalNo) ? 'X' : '';
    const finalRemark = finalYes || finalNo ? remark || 'No remarks' : 'No picture or remarks';

    if (finalYes) mhYesCount++;

    if (finalYes && file && file.size <= 1024 * 1024) {
      try {
        const base64 = await toBase64(file);
        const img = new Image();
        img.src = base64;
        await new Promise(resolve => img.onload = resolve);

        const fixedWidth = 28;
        const scale = fixedWidth / img.width;
        const scaledHeight = img.height * scale;

        mhImageDataArray.push({
          index: `mh${i}`,
          data: base64,
          width: fixedWidth,
          height: scaledHeight
        });

        mhRows.push([manualData[i].activity, manualData[i].rweight, isYes + isNo, '']);
      } catch (error) {
        mhRows.push([manualData[i].activity, manualData[i].rweight, isYes + isNo, 'Error loading image.']);
      }
    } else {
// No image: just show text
const displayText = finalYes || finalNo ? finalRemark : 'No picture or remarks';
    mhRows.push([manualData[i].activity, manualData[i].rweight, isYes + isNo, displayText]);
    }
  }

  doc.autoTable({
    head: [['Activity', 'Recommended Weight', 'Exceed Limit?', 'Remarks or Photos']],
    body: mhRows,
    startY: 35,
    theme: 'grid',
    styles: {
      fontSize: 10,
      cellPadding: 3,
      valign: 'middle',
      halign: 'center',
      overflow: 'linebreak'
    },
    headStyles: {
      fillColor: [120, 120, 120],
      textColor: [255, 255, 255],
      fontStyle: 'bold'
    },
    columnStyles: {
      0: { cellWidth: 45 },
      1: { cellWidth: 35 },
      2: { cellWidth: 20 },
      3: { cellWidth: 'auto' }
    },
    didParseCell: function (data) {
      if (data.section === 'body' && data.column.index === 3) {
        const image = mhImageDataArray.find(img => img.index === `mh${data.row.index}`);
        if (image) {
          const lines = Math.ceil((image.height * 1.2) / 3);
          data.cell.text = Array(lines).fill('\n');
        }
      }
    },
    didDrawCell: function (data) {
      if (data.section === 'body' && data.column.index === 3) {
        const image = mhImageDataArray.find(img => img.index === `mh${data.row.index}`);
        if (image) {
          const imgWidthMM = image.width * 1.4;
          const imgHeightMM = image.height * 1.4;
          const imgX = data.cell.x + (data.cell.width - imgWidthMM) / 2;
          const imgY = data.cell.y + (data.cell.height - imgHeightMM) / 2;
          const format = image.data.includes('image/png') ? 'PNG' : 'JPEG';
          doc.addImage(image.data, format, imgX, imgY, imgWidthMM, imgHeightMM);
        }
      }
    }
  });

  doc.autoTable({
    body: [[`Sub Total (Number of tick(s)): ${mhYesCount}`]],
    startY: doc.previousAutoTable.finalY + 10,
    styles: {
      fontSize: 12,
      fontStyle: 'bold',
      halign: 'center'
    }
  });

        // --- PAGE 7: Vibration click ---
        doc.addPage();
        doc.text('Page 7', 105, 15, { align: "center" });
        const pageCenter = doc.internal.pageSize.getWidth() / 2;

  const imageDataArray7 = [];
  let totalYesRepetitive = 0;
  let totalYesVibration = 0;

  doc.setFontSize(14);
  doc.setFont("helvetica", "bold");
  doc.text("ERGONOMICS RISK FACTORS: REPETITIVE MOTION", doc.internal.pageSize.width / 2, 15, { align: "center" });


  let startY = 6 + 15;

  // Build first table: Motion Data
  const motionRows = [];

  for (let i = 0; i < MotionData.length; i++) {
    const yesRadio = document.querySelector(`input[name="motion${i}"][value="Yes"]`);
    const noRadio = document.querySelector(`input[name="motion${i}"][value="No"]`);
    const finalYes = yesRadio?.checked;
    const finalNo = noRadio?.checked;
    const remark = document.getElementById(`remarkPhoto${i}`).value;
    const file = document.getElementById(`#form7 #remarkPhoto${i}`).files[0];

    const isYes = finalYes ? '/' : '';
    const isNo = finalNo || (!finalYes && !finalNo) ? '/' : '';
    const finalRemark = finalYes || finalNo ? remark || 'No remarks' : 'No picture or remarks';

    if (finalYes) totalYesRepetitive++;

    if (finalYes && file && file.size <= 1024 * 1024) {
      try {
        const base64 = await toBase64(file);
        const img = new Image();
        img.src = base64;
        await new Promise(resolve => img.onload = resolve);

        const fixedWidth = 28;
        const scale = fixedWidth / img.width;
        const scaledHeight = img.height * scale;

        imageDataArray7.push({
          index: `motion${i}`,
          data: base64,
          width: fixedWidth,
          height: scaledHeight
        });

        motionRows.push([MotionData[i].part, MotionData[i].factor, MotionData[i].duration, isYes, isNo, '']);
      } catch {
        motionRows.push([MotionData[i].part, MotionData[i].factor, MotionData[i].duration, isYes, isNo, 'Error loading image.']);
      }
    } else {
      motionRows.push([MotionData[i].part, MotionData[i].factor, MotionData[i].duration, isYes, isNo, finalRemark]);
    }
  }

  doc.autoTable({
    head: [['Body Part', 'Physical Risk Factor', 'Max. Exposure Duration', 'Yes', 'No', 'Remarks or Photos']],
    body: motionRows,
    startY: startY,
    theme: 'grid',
    styles: {
      fontSize: 10,
      cellPadding: 3,
      valign: 'middle',
      halign: 'center',
      overflow: 'linebreak'
    },
    headStyles: {
      fillColor: [100, 100, 100],
      textColor: [255, 255, 255],
      fontStyle: 'bold'
    },
    columnStyles: {
      0: { cellWidth: 30 },
      1: { cellWidth: 38 },
      2: { cellWidth: 28 },
      3: { cellWidth: 14 },
      4: { cellWidth: 14 },
      5: { cellWidth: 'auto' }
    },
    didParseCell: function (data) {
      if (data.section === 'body' && data.column.index === 5) {
        const image = imageDataArray7.find(img => img.index === `motion${data.row.index}`);
        if (image) {
          const lines = Math.ceil((image.height * 1.2) / 3);
          data.cell.text = Array(lines).fill('\n');
        }
      }
    },
    didDrawCell: function (data) {
      if (data.section === 'body' && data.column.index === 5) {
        const image = imageDataArray7.find(img => img.index === `motion${data.row.index}`);
        if (image) {
          const imgWidthMM = image.width * 1.4;
          const imgHeightMM = image.height * 1.4;
          const imgX = data.cell.x + (data.cell.width - imgWidthMM) / 2;
          const imgY = data.cell.y + (data.cell.height - imgHeightMM) / 2;
          const format = image.data.includes('image/png') ? 'PNG' : 'JPEG';
          doc.addImage(image.data, format, imgX, imgY, imgWidthMM, imgHeightMM);
        }
      }
    }
  });

  doc.autoTable({
    body: [[`Sub Total (Number of tick(s)): ${totalYesRepetitive}`]],
    startY: doc.previousAutoTable.finalY + 10,
    styles: {
      fontSize: 12,
      fontStyle: 'bold',
      halign: 'center'
    }
  });

  // Second table: Vibration (similar to Motion Table)
  const vibrationRows = [];
  for (let i = 0; i < VibrationData.length; i++) {
    const index = i + MotionData.length;
    const yesRadio = document.querySelector(`input[name="vibration${i}"][value="Yes"]`);
    const noRadio = document.querySelector(`input[name="vibration${i}"][value="No"]`);
    const finalYes = yesRadio?.checked;
    const finalNo = noRadio?.checked;
    const remark = document.getElementById(`remarkPhoto${index}`).value;
    const file = document.getElementById(`remarkPhoto${index}File`).files[0];

    const isYes = finalYes ? '/' : '';
    const isNo = finalNo || (!finalYes && !finalNo) ? '/' : '';
    const finalRemark = finalYes || finalNo ? remark || 'No remarks' : 'No picture or remarks';

    if (finalYes) totalYesVibration++;

    if (finalYes && file && file.size <= 1024 * 1024) {
      try {
        const base64 = await toBase64(file);
        const img = new Image();
        img.src = base64;
        await new Promise(resolve => img.onload = resolve);

        const fixedWidth = 28;
        const scale = fixedWidth / img.width;
        const scaledHeight = img.height * scale;

        imageDataArray7.push({
          index: `vibration${i}`,
          data: base64,
          width: fixedWidth,
          height: scaledHeight
        });

        vibrationRows.push([VibrationData[i].part, VibrationData[i].factor, VibrationData[i].duration, isYes, isNo, '']);
      } catch {
        vibrationRows.push([VibrationData[i].part, VibrationData[i].factor, VibrationData[i].duration, isYes, isNo, 'Error loading image.']);
      }
    } else {
      vibrationRows.push([VibrationData[i].part, VibrationData[i].factor, VibrationData[i].duration, isYes, isNo, finalRemark]);
    }
  }

const pageHeight = doc.internal.pageSize.height;
const remainingSpace = pageHeight - doc.previousAutoTable.finalY;

// If not enough space, add a new page
if (remainingSpace < 40) {
  doc.addPage();
}

// Set Y-position: 20 if new page, otherwise just after last table
const vibrationHeaderY = (remainingSpace < 40) ? 20 : doc.previousAutoTable.finalY + 10;
doc.setFontSize(14);
doc.setFont("helvetica", "bold");
doc.text("ERGONOMICS RISK FACTORS: VIBRATION", doc.internal.pageSize.width / 2, vibrationHeaderY, { align: "center" });


  doc.autoTable({
    head: [['Body Part', 'Physical Risk Factor', 'Max. Exposure Duration', 'Yes', 'No', 'Remarks or Photos']],
    body: vibrationRows,
    startY: vibrationHeaderY + 6,
    theme: 'grid',
    styles: {
      fontSize: 10,
      cellPadding: 3,
      valign: 'middle',
      halign: 'center',
      overflow: 'linebreak'
    },
    headStyles: {
      fillColor: [100, 100, 100],
      textColor: [255, 255, 255],
      fontStyle: 'bold'
    },
    columnStyles: {
      0: { cellWidth: 30 },
      1: { cellWidth: 38 },
      2: { cellWidth: 28 },
      3: { cellWidth: 14 },
      4: { cellWidth: 14 },
      5: { cellWidth: 'auto' }
    },
    didParseCell: function (data) {
      if (data.section === 'body' && data.column.index === 5) {
        const image = imageDataArray7.find(img => img.index === `vibration${data.row.index}`);
        if (image) {
          const lines = Math.ceil((image.height * 1.2) / 3);
          data.cell.text = Array(lines).fill('\n');
        }
      }
    },
    didDrawCell: function (data) {
      if (data.section === 'body' && data.column.index === 5) {
        const image = imageDataArray7.find(img => img.index === `vibration${data.row.index}`);
        if (image) {
          const imgWidthMM = image.width * 1.4;
          const imgHeightMM = image.height * 1.4;
          const imgX = data.cell.x + (data.cell.width - imgWidthMM) / 2;
          const imgY = data.cell.y + (data.cell.height - imgHeightMM) / 2;
          const format = image.data.includes('image/png') ? 'PNG' : 'JPEG';
          doc.addImage(image.data, format, imgX, imgY, imgWidthMM, imgHeightMM);
        }
      }
    }
  });

  doc.autoTable({
    body: [[`Sub Total (Number of tick(s)): ${totalYesVibration}`]],
    startY: doc.previousAutoTable.finalY + 10,
    styles: {
      fontSize: 12,
      fontStyle: 'bold',
      halign: 'center'
    }
  });


        // --- PAGE 8: Final Comments click ---
        doc.addPage();
        doc.text('Page 8', 105, 15, { align: "center" });
         const rows1 = [];
      const imageDataArray = [];
      let totalYes = 0;

              // STATIC POSTURE TABLE
  for (let i = 0; i < staticData.length; i++) {
    const yesRadio = document.querySelector(`#form8 input[name="sp${i}"][value="Yes"]`);
    const noRadio = document.querySelector(`#form8 input[name="sp${i}"][value="No"]`);
    const finalYes = yesRadio?.checked;
    const finalNo = noRadio?.checked;
    const remark = document.querySelector(`#form8 #spr${i}`)?.value || '';
    const file = document.querySelector(`#form8 #spf${i}`)?.files[0];

    const isYes = finalYes ? '/' : '';
    const isNo = finalNo || (!finalYes && !finalNo) ? '/' : '';
    const finalRemark = finalYes || finalNo ? remark || 'No remarks' : 'No picture or remarks';

    if (finalYes) totalYes++;

    if (finalYes && file && file.size <= 1024 * 1024) {
      try {
        const base64 = await toBase64(file);
        const img = new Image();
        img.src = base64;
        await new Promise(resolve => img.onload = resolve);

        const fixedWidth = 28;
        const scale = fixedWidth / img.width;
        const scaledHeight = img.height * scale;

        imageDataArray.push({
          index: `sp${i}`,
          data: base64,
          width: fixedWidth,
          height: scaledHeight
        });

        rows1.push([
          staticData[i].part,
          isYes,
          isNo,
          ''
        ]);
      } catch (error) {
        rows1.push([
          staticData[i].part,
          isYes,
          isNo,
          'Error loading image.'
        ]);
      }
    } else {
      rows1.push([
        staticData[i].part,
        isYes,
        isNo,
        finalRemark
      ]);
    }
  }

  doc.autoTable({
    head: [['Body Part', 'Yes', 'No', 'Remarks or Photos']],
    body: rows1,
    startY: 25,
    theme: 'grid',
    styles: {
      fontSize: 10,
      cellPadding: 3,
      valign: 'middle',
      halign: 'center',
      overflow: 'linebreak'
    },
    headStyles: {
      fillColor: [120, 120, 120],
      textColor: [255, 255, 255],
      fontStyle: 'bold'
    },
    columnStyles: {
      0: { cellWidth: 45},
      1: { cellWidth: 14},
      2: { cellWidth: 14 },
      3: { cellWidth: 'auto' }
    },
    didParseCell: function (data) {
      if (data.section === 'body' && data.column.index === 3) {
        const image = imageDataArray.find(img => img.index === `sp${data.row.index}`);
        if (image) {
          const lines = Math.ceil((image.height * 1.2) / 3);
          data.cell.text = Array(lines).fill('\n');
        }
      }
    },
    didDrawCell: function (data) {
      if (data.section === 'body' && data.column.index === 3) {
        const image = imageDataArray.find(img => img.index === `sp${data.row.index}`);
        if (image) {
          const imgWidthMM = image.width * 1.4;
          const imgHeightMM = image.height * 1.4;
          const imgX = data.cell.x + (data.cell.width - imgWidthMM) / 2;
          const imgY = data.cell.y + (data.cell.height - imgHeightMM) / 2;
          const format = image.data.includes('image/png') ? 'PNG' : 'JPEG';
          doc.addImage(image.data, format, imgX, imgY, imgWidthMM, imgHeightMM);
        }
      }
    }
  });

  doc.autoTable({
    body: [[`Sub Total (Number of tick(s)): ${totalYes}`]],
    startY: doc.previousAutoTable.finalY + 10,
    styles: {
      fontSize: 12,
      fontStyle: 'bold'
    }
  });

  let afterTableY = doc.autoTableEndPosY(); // Get the position right after the table


      const nextY = afterTableY + 20;
      doc.setFontSize(16);
      doc.text("Initial ERA Form", 105, nextY, null, null, "center");
  
      // Collect Result of Initial ERA values
      const resultInputs = document.querySelectorAll('input[name="result[]"]');
      const results = Array.from(resultInputs).map(input => input.value || "0");
  
      const actionInputs = document.querySelectorAll('input[name="action"]');
      const actions = Array.from(actionInputs).map(input => {
  const label = input.dataset.label;
  const value = input.value.trim() === "" ? "0" : input.value.trim();
  return { label, value };
});

const needAdvancedERA = actions.some(action => parseFloat(action.value) > 0) ? "Yes" : "No";

const actionsText = actions
  .filter(action => action.value)
  .map(action => `${action.label}: ${action.value}`)
  .join('\n');

  
      // Define all possible body parts
const allBodyParts = [
  "Neck", "Shoulder", "Upper back", "Lower back",
  "Upper arm", "Elbow", "Lower Arm", "Hand/Wrist",
  "Thigh", "Knee", "Lower leg", "Ankle/Foot"
];

// Collect checked body parts
const checkedBodyParts = Array.from(document.querySelectorAll('input[name="body"]:checked'))
  .map(input => input.value);

// Construct the body text with '/' for selected parts
let bodyText = "If YES please tick which part of body:\n\n";
bodyText += allBodyParts.map(part => checkedBodyParts.includes(part) ? `/   ${part}` : part).join('\n');

  
      // Determine "Need advanced ERA" status
      function getNeedAdvancedERA(value) {
        return parseFloat(value) > 0 ? "Yes" : "No";
      }

      // Debugging: Check the values in each row before generating PDF
  const rows = [
    ['Awkward posture', '13', '1-6', results[0], '', getNeedAdvancedERA(results[0])],
    ['Static and sustained work posture', '3', '1', results[1], '', getNeedAdvancedERA(results[1])],
    ['Forceful exertion', '1', '1', actions.map(a => `${a.label}: ${a.value}`).join('\n'), bodyText.trim(), needAdvancedERA],
    ['Repetition', '5', '1', results[2], '', getNeedAdvancedERA(results[2])],
    ['Vibration', '4', '1', results[3], '', getNeedAdvancedERA(results[3])],
    ['Lighting', '1', '1', results[4], '', getNeedAdvancedERA(results[4])],
    ['Temperature', '1', '1', results[5], '', getNeedAdvancedERA(results[5])],
    ['Ventilation', '1', '1', results[6], '', getNeedAdvancedERA(results[6])],
    ['Noise', '2', '1', results[7], '', getNeedAdvancedERA(results[7])]
  ];

  console.log("Rows for PDF:", rows); // Debugging output for the row data
  
      // Build table
      doc.autoTable({
        startY: nextY + 10,
        head: [[
          'Risk Factor', 'Total score', 'Minimum Requirements for Advance ERA',
          'Result of Initial ERA', 'Any pain or discomfort (Yes/No)', 'Need advanced ERA (Yes/No)'
        ]],
        body: rows,
        styles: {
          halign: 'center',
          valign: 'middle',
          fontSize: 8
        },
        columnStyles: {
          3: { cellWidth: 40, fillColor: [219, 231, 245] },
          4: { cellWidth: 40, fillColor: [255, 242, 204], halign: 'left' },
          5: { cellWidth: 20, fillColor: [217, 234, 211] }
        },
        didParseCell: function (data) {
    // Target only the "body part" cell (column index 4) for the Forceful exertion row (row index 2)
    if (data.row.index === 2 && data.column.index === 4) {
      data.cell.styles.halign = 'center'; // Center-align
      data.cell.styles.valign = 'middle'; // Vertical center (optional)
    }
  }

      });

        doc.save("Ergonomics_Assessment_All.pdf");
    }

    async function generatePage3(doc) {
    // --- PAGE 3: Repetitive ---

    function toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        })};

    doc.addPage();
        doc.setFontSize(14);
  doc.text("PAGE 3: ERGONOMICS RISK FACTORS: STATIC AND SUSTAINED WORK POSTURE", doc.internal.pageSize.getWidth() / 2, 15, { align: "center" });

  const rows3 = [];
  const imageDataArray3 = [];
  let totalYes3 = 0;

  // STATIC POSTURE TABLE
  for (let i = 0; i < staticData3.length; i++) {
    const yesRadio = document.querySelector(`input[name="sp${i}"][value="Yes"]`);
    const noRadio = document.querySelector(`input[name="sp${i}"][value="No"]`);
    const finalYes = yesRadio?.checked;
    const finalNo = noRadio?.checked;
    const remark = document.getElementById(`spr${i}`).value;
    const file = document.getElementById(`spf${i}`).files[0];

    const isYes = finalYes ? '/' : '';
    const isNo = finalNo || (!finalYes && !finalNo) ? '/' : '';
    const finalRemark = finalYes || finalNo ? remark || 'No remarks' : 'No picture or remarks';

    if (finalYes) totalYes3++;

    if (finalYes && file && file.size <= 1024 * 1024) {
      try {
        const base64 = await toBase64(file);
        const img = new Image();
        img.src = base64;
        await new Promise(resolve => img.onload = resolve);

        const fixedWidth = 28;
        const scale = fixedWidth / img.width;
        const scaledHeight = img.height * scale;

        imageDataArray3.push({
          index: `sp${i}`,
          data: base64,
          width: fixedWidth,
          height: scaledHeight
        });

        rows3.push([
          staticData3[i].part,
          staticData3[i].factor,
          staticData3[i].duration,
          isYes,
          isNo,
          ''
        ]);
      } catch (error) {
        rows3.push([
          staticData3[i].part,
          staticData3[i].factor,
          staticData3[i].duration,
          isYes,
          isNo,
          'Error loading image.'
        ]);
      }
    } else {
      rows3.push([
        staticData3[i].part,
        staticData3[i].factor,
        staticData3[i].duration,
        isYes,
        isNo,
        finalRemark
      ]);
    }
  }

  // RENDER STATIC POSTURE TABLE
  doc.autoTable({
    head: [['Body Part', 'Physical Risk Factor', 'Max. Exposure Duration', 'Yes', 'No', 'Remarks or Photos']],
    body: rows3,
    startY: 20,
    theme: 'grid',
    styles: {
      fontSize: 10,
      cellPadding: 3,
      valign: 'middle',
      halign: 'center',
      overflow: 'linebreak'
    },
    headStyles: {
      fillColor: [120, 120, 120],
      textColor: [255, 255, 255],
      fontStyle: 'bold'
    },
    columnStyles: {
  0: { cellWidth: 25 },
  1: { cellWidth: 35 },
  2: { cellWidth: 25 },
  3: { cellWidth: 12 },
  4: { cellWidth: 12 },
  5: { cellWidth: 'auto' }
},
    didParseCell: function (data) {
      if (data.section === 'body' && data.column.index === 5) {
        const image = imageDataArray3.find(img => img.index === `sp${data.row.index}`);
        if (image) {
          const lines = Math.ceil((image.height * 1.2) / 3);
          data.cell.text = Array(lines).fill('\n');
        }
      }
    },
    didDrawCell: function (data) {
      if (data.section === 'body' && data.column.index === 5) {
        const image = imageDataArray3.find(img => img.index === `sp${data.row.index}`);
        if (image) {
          const imgWidthMM = image.width * 1.4;
          const imgHeightMM = image.height * 1.4;
          const imgX = data.cell.x + (data.cell.width - imgWidthMM) / 2;
          const imgY = data.cell.y + (data.cell.height - imgHeightMM) / 2;
          const format = image.data.includes('image/png') ? 'PNG' : 'JPEG';
          doc.addImage(image.data, format, imgX, imgY, imgWidthMM, imgHeightMM);
        }
      }
    }
  });

  doc.autoTable({
    body: [[`Sub Total (Number of tick(s)): ${totalYes3}`]],
    startY: doc.previousAutoTable.finalY + 10,
    styles: {
      fontSize: 12,
      fontStyle: 'bold'
    }
  });

  // MANUAL HANDLING TABLE

  // Add spacing after static posture subtotal
const nextY3 = doc.previousAutoTable.finalY + 15;
// Set the font size for the title
doc.setFontSize(14);
doc.text("ERGONOMICS RISK FACTORS: FORCEFUL EXERTION (MANUAL HANDLING)", doc.internal.pageSize.getWidth() / 2, nextY3, { align: "center" });

const subtextY = nextY3 + 7;

// Set slightly smaller font size for the subtext
doc.setFontSize(12);
doc.text("Ergonomics Risk Factors: Forceful Exertion", doc.internal.pageSize.getWidth() / 2, subtextY, { align: "center" });
doc.text("(Manual handling – Lifting and/or lowering)", doc.internal.pageSize.getWidth() / 2, subtextY + 6, { align: "center" });

  // Add Figure 1 image below the title
  const figureImage3 = new Image();
figureImage3.src = 'Figure_1.png';
await new Promise(resolve => figureImage3.onload = resolve);

// Set desired width (smaller than original)
const scaledWidth3 = 100; // You can adjust this (e.g., 80, 120)
const scaleRatio3 = scaledWidth3 / figureImage3.width;
const scaledHeight3 = figureImage3.height * scaleRatio3;

// Get PDF page width
const pageWidth3 = doc.internal.pageSize.getWidth();
const pageHeight3 = doc.internal.pageSize.getHeight();

// Calculate X to center the image
const centerX3 = (pageWidth3 - scaledWidth3) / 2;

// Y position (below the title)
let figY3 = subtextY + 12;

// Calculate remaining space on the page
const remainingSpace3 = pageHeight3 - figY3;

// 👉 If only a small portion will be cut off, push it slightly up instead of a full page jump
if (scaledHeight3 > remainingSpace3) {
  const overflow = scaledHeight3 - remainingSpace3;

  // If overflow is small (e.g., < 30), push image up slightly (pull back figY)
  if (overflow < 10) {
    figY3 = pageHeight3 - scaledHeight3 - 10; // Just enough so image fully fits
  } else {
    // If too much overflow, move to a new page cleanly
    doc.addPage();
    figY3 = 40; // Minimal margin from top
  }
}

// Add the image to the PDF centered and scaled
doc.addImage(figureImage3, 'PNG', centerX3, figY3, scaledWidth3, scaledHeight3);

// Adjust the Y position of the table below the image
const tableStartY3 = figY3 + scaledHeight3 + 10;

//-----------------------------------------------------------------------------
  const mhRows3 = [];
  const mhImageDataArray3 = [];
  let mhYesCount3 = 0;

  for (let i = 0; i < manualData3.length; i++) {
    const maleRadio = document.querySelector(`input[name="gender${i}"][value="Male"]`);
    const femaleRadio = document.querySelector(`input[name="gender${i}"][value="Female"]`);
    const currentWeight = document.getElementById(`mhWeight${i}`).value;
    const yesRadio = document.querySelector(`input[name="mh3${i}"][value="Yes"]`);
    const noRadio = document.querySelector(`input[name="mh3${i}"][value="No"]`);
    const finalYes = yesRadio?.checked;
    const finalNo = noRadio?.checked;
    const remark = document.getElementById(`mhr${i}`).value;
    const file = document.querySelector(`#form3 #mhf${i}`)?.files[0];

    const isYes = finalYes ? '/' : '';
    const isNo = finalNo || (!finalYes && !finalNo) ? 'X' : '';
    const finalRemark = finalYes || finalNo ? remark || 'No remarks' : 'No picture or remarks';

    let recommendedWeight = '';
    if (finalYes) mhYesCount3++;

    if (finalYes && file && file.size <= 1024 * 1024) {
      try {
        const base64 = await toBase64(file);
        const img = new Image();
        img.src = base64;
        await new Promise(resolve => img.onload = resolve);

        const fixedWidth = 28;
        const scale = fixedWidth / img.width;
        const scaledHeight3 = img.height * scale;

        mhImageDataArray3.push({
          index: `page3_mhf${i}`,
          data: base64,
          width: fixedWidth,
          height: scaledHeight3
        });

        // Determine selected gender
if (maleRadio && maleRadio.checked) {
  recommendedWeight = 'Male';
} else if (femaleRadio && femaleRadio.checked) {
  recommendedWeight = 'Female';
} else {
  recommendedWeight = 'Not selected';
}

        mhRows3.push([manualData3[i].height, recommendedWeight, currentWeight, isYes + isNo, '']);
      } catch (error) {
        mhRows3.push([manualData3[i].height, recommendedWeight, currentWeight, isYes + isNo, 'Error loading image.']);
      }
    } else {
if (maleRadio && maleRadio.checked) {
  recommendedWeight = 'Male';
} else if (femaleRadio && femaleRadio.checked) {
  recommendedWeight = 'Female';
} else {
  recommendedWeight = 'Not selected';
}
        mhRows3.push([manualData3[i].height, recommendedWeight, currentWeight, isYes + isNo, finalRemark]);
    }
  }

  doc.autoTable({
    head: [['Working Height', 'Recommended Weight', 'Current Weight', 'Exceed Limit?', 'Remarks or Photos']],
    body: mhRows3,
    startY: tableStartY3,
    theme: 'grid',
    styles: {
      fontSize: 10,
      cellPadding: 3,
      valign: 'middle',
      halign: 'center',
      overflow: 'linebreak'
    },
    headStyles: {
      fillColor: [120, 120, 120],
      textColor: [255, 255, 255],
      fontStyle: 'bold'
    },
    columnStyles: {
      0: { cellWidth: 40 },
      1: { cellWidth: 32 },
      2: { cellWidth: 23 },
      3: { cellWidth: 20 },
      4: { cellWidth: 'auto' }
    },
    didParseCell: function (data) {
      if (data.section === 'body' && data.column.index === 4) {
        const image = mhImageDataArray3.find(img => img.index === `page3_mhf${data.row.index}`);
        if (image) {
          const lines = Math.ceil((image.height * 1.2) / 3);
          data.cell.text = Array(lines).fill('\n');
        }
      }
    },
    didDrawCell: function (data) {
      if (data.section === 'body' && data.column.index === 4) {
        const image = mhImageDataArray3.find(img => img.index === `page3_mhf${data.row.index}`);
        if (image) {
          const imgWidthMM = image.width * 1.4;
          const imgHeightMM = image.height * 1.4;
          const imgX = data.cell.x + (data.cell.width - imgWidthMM) / 2;
          const imgY = data.cell.y + (data.cell.height - imgHeightMM) / 2;
          const format = image.data.includes('image/png') ? 'PNG' : 'JPEG';
          doc.addImage(image.data, format, imgX, imgY, imgWidthMM, imgHeightMM);
        }
      }
    }
  });

  doc.autoTable({
    body: [[`Sub Total (Number of tick(s)): ${mhYesCount3}`]],
    startY: doc.previousAutoTable.finalY + 10,
    styles: {
      fontSize: 12,
      fontStyle: 'bold'
    }
  });
    }
</script>
</body>
</html>
