<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Super Admin Dashboard</title>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      background-color: #f0f4f8;
      color: #333;
    }

    header {
      background-color: #004085;
      color: white;
      padding: 20px;
      text-align: center;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .section {
      background-color: white;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    .action-buttons {
  display: flex;
  flex-direction: row; /* Force horizontal layout */
  gap: 10px;           /* Adjust spacing between buttons */
  flex-wrap: wrap;     /* Optional: wraps to new line if too long */
  justify-content: flex-start; /* Align to the left */
}

    h2, h3 {
      color: #004085;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 12px 15px;
      text-align: left;
    }

    th {
      background-color: #e1ecf4;
      color: #004085;
    }

    td {
      background-color: #ffffff;
      border-bottom: 1px solid #ddd;
    }

    input, select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
    }

    button {
      background-color: #282829;
      color: white;
      padding: 6px 10px;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #0056b3;
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      input, select, button {
        font-size: 14px;
      }

      table {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Super Admin Dashboard</h1>
    <p>Welcome, Mr Asyraf</p>
  </header>
  <div class="container">   
      
      <div class="section">
        <h2>Program List</h2>
        <table id="programListTable">
          <thead>
            <tr>
              <th style="width: 15%;">Title</th>
              <th style="width: 8%;">CEP Points</th>
    <th style="width: 8%;">State</th>
    <th style="width: 15%;">Venue</th>
    <th style="width: 14%;">Date(s)</th>
    <th style="width: 7%;">Slots</th>
    <th style="width: 10%;">Participants</th>
    <th style="width: 20%;">Fee Setup</th>
              <div id="participantManager" style="display: none; padding: 20px; border: 1px solid #ccc; background: #fff;"></div>
              <th style="width: 12%;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <!-- Below Program List Section -->
        <button onclick="hideProgramForm()">Hide Program</button>
<button id="toggleProgramBtn" onclick="toggleProgramForm()">Add Program</button>
      </div>     

      <div id="programManagementSection" class="section">
        <h2>Program Management</h2>
        <input type="text" id="progTitle" placeholder="Enter program title" required>

<select id="cepPoints">
  <option value="">-- Select CEP Points --</option>
  <option value="CEP 10">CEP 10</option>
  <option value="CEP 5">CEP 5</option>
  <option value="CEP 0">CEP 0</option>
</select>

        <!-- State Dropdown -->
  <select id="progState">
    <option value="">-- Select State --</option>
    <option value="Johor">Johor</option>
    <option value="Kedah">Kedah</option>
    <option value="Kelantan">Kelantan</option>
    <option value="Melaka">Melaka</option>
    <option value="Negeri Sembilan">Negeri Sembilan</option>
    <option value="Pahang">Pahang</option>
    <option value="Penang">Penang</option>
    <option value="Perak">Perak</option>
    <option value="Perlis">Perlis</option>
    <option value="Sabah">Sabah</option>
    <option value="Sarawak">Sarawak</option>
    <option value="Selangor">Selangor</option>
    <option value="Terengganu">Terengganu</option>
    <option value="Kuala Lumpur">Kuala Lumpur</option>
    <option value="Labuan">Labuan</option>
    <option value="Putrajaya">Putrajaya</option>
  </select>

  <input id="progVenue" placeholder="Venue">
        <!-- Calendar Dates -->
  <label>Start Date:</label>
  <input type="date" id="startDate">
  <label>End Date:</label>
  <input type="date" id="endDate">

  <input type="number" id="progSlots" placeholder="Maximum Slots (e.g. 50)" min="1">

  <!-- Session Dropdown -->
  <select id="progSession">
    <option value="">-- Select Session --</option>
    <option value="Physical">Physical</option>
    <option value="Online">Online</option>
  </select>
        <button onclick="saveProgramToFirebase()">Save Program</button>
      </div> 

    <div class="section">
        <h2>Admin Users</h2>
        <table id="adminTable">
          <thead>
            <tr>
              <th style="width: 30%;">Full Name</th>
              <th style="width: 10%;">Company</th>
              <th style="width: 10%;">Department</th>
              <th style="width: 10%;">Task</th>
              <th style="width: 10%;">Status</th>
              <th style="width: 40%;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="section">
        <h2>Respondents</h2>
        <table id="respondentTable">
          <thead>
            <tr>
              <th style="width: 30%;">Full Name</th>
              <th style="width: 10%;">Company</th>
              <th style="width: 10%;">Department</th>
              <th style="width: 10%;">Task</th>
              <th style="width: 10%;">Status</th>
              <th style="width: 40%;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="section">
        <h2>Company List</h2>
        <table id="companyListTable">
          <thead>
            <tr>
              <th>Company</th>
              <th>Departments</th>
              <th>Tasks</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button onclick="hideCompany()">Hide Company</button>
        <button id="toggleCompanyBtn" onclick="toggleCompanyGroup()">Add Company</button>
      </div>
      
    <!-- Company Management Section -->
    <div id="companyGroupSection">
    <div class="section">
      <h2>Company Management</h2>
      <input type="text" id="companyInput" placeholder="Enter new company name">
      <button onclick="addCompany()">Add Company</button>

      <select id="companySelect" onchange="selectCompany()">
        <option value="">-- Select Company --</option>
      </select>
      <button onclick="deleteCompany()">Delete Company</button>
    </div>

    <!-- Department Management -->
<div class="section">
  <h3>Department Management</h3>
  <input type="text" id="deptInput" placeholder="Enter new department">
  <button onclick="addDepartment()">Add Department</button>

  <select id="deptSelect" onchange="selectDepartment()">
    <option value="">-- Select Department --</option> <!-- Default Option -->
  </select>
  <button onclick="deleteDepartment()">Delete Department</button>

  <ul id="deptList"></ul> <!-- List of departments with Delete options -->
</div>

    <!-- Task Management -->
    <div class="section">
      <h3>Tasks for <span id="selectedDeptName">[Select Department]</span></h3>
      <input type="text" id="taskInput" placeholder="Enter task">
      <button onclick="addTask()">Add Task</button>
      <ul id="taskList"></ul>
    </div>
</div>

    <button onclick="logout()">Logout</button>

  </div>

  <script type="module">
    window.saveProgramToFirebase = saveProgramToFirebase;

const username = sessionStorage.getItem("username");
  const password = sessionStorage.getItem("password");

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, get, set, child, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAxfj2GwpREdwwvSL1_LhTUnSWAUwUT9pQ",
      authDomain: "ergo-1140d.firebaseapp.com",
      databaseURL: "https://ergo-1140d-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ergo-1140d",
      storageBucket: "ergo-1140d.appspot.com",
      messagingSenderId: "139659476541",
      appId: "1:139659476541:web:78fd5c1593fae30f747454",
      measurementId: "G-NNGVRF3E5D"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const analytics = getAnalytics(app);

    let selectedCompany = "";
    let selectedDepartment = "";
    let currentEditKey = null;

    function saveProgram() {
  const program = {
    title: document.getElementById('progTitle').value.trim(),
    state: document.getElementById('progState').value.trim(),
    venue: document.getElementById('progVenue').value.trim(),
    dates: document.getElementById('progDates').value.trim(),
    slots: document.getElementById('progSlots').value.trim(),
    session: document.getElementById('progSession').value.trim(),
    cepPoints: document.getElementById('cepPoints').value.trim()
  };

  localStorage.setItem('programInfo', JSON.stringify(program));
  alert("Program information saved!");
}

function renderCompanyList() {
  const userId = "user1";
  const tbody = document.querySelector('#companyListTable tbody');
  tbody.innerHTML = '';

  const companiesRef = ref(database, `users/${userId}/ListCompany`);
  get(companiesRef).then(snapshot => {
    if (snapshot.exists()) {
      const companies = snapshot.val();
      Object.entries(companies).forEach(([key, data]) => {
        const tr = document.createElement('tr');

        const tdCompany = document.createElement('td');
        tdCompany.textContent = data.name || key;
        tr.appendChild(tdCompany);

        const tdDepts = document.createElement('td');
        tdDepts.textContent = (data.departments || []).join(', ');
        tr.appendChild(tdDepts);

        const tdTasks = document.createElement('td');
        let taskHTML = '';
        if (data.tasks) {
          Object.entries(data.tasks).forEach(([dept, tasks]) => {
            taskHTML += `<strong>${dept}:</strong><ul>${tasks.map(t => `<li>${t}</li>`).join('')}</ul>`;
          });
        }
        tdTasks.innerHTML = taskHTML || '-';
        tr.appendChild(tdTasks);

        const tdActions = document.createElement('td');
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.onclick = () => toggleCompanyEdit(key);

        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.style.marginLeft = '10px';
        delBtn.onclick = () => deleteCompanyEntry(key);

        tdActions.appendChild(editBtn);
        tdActions.appendChild(delBtn);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });
    }
  });
}

let currentEditCompany = null;
function toggleCompanyEdit(key) {
  selectedCompany = key;
  document.getElementById('companyGroupSection').style.display = 'block';
  document.getElementById('companySelect').value = key;
  loadDepartments();
  document.getElementById('selectedDeptName').textContent = selectedDepartment || "[Select Department]";
  loadTasks();
}

function editCompany(companyName) {
  document.getElementById('companyInput').value = companyName;
  document.getElementById('companySelect').value = companyName;
  selectedCompany = companyName;
  loadDepartments();
  document.getElementById('selectedDeptName').textContent = selectedDepartment || "[Select Department]";
  loadTasks();
}

function deleteCompanyEntry(key) {
  const userId = "user1";
  const companyRef = ref(database, `users/${userId}/ListCompany/${key}`);
  if (confirm(`Are you sure you want to delete this company?`)) {
    set(companyRef, null).then(() => {
      alert("Company deleted.");
      populateCompanySelect();
      renderCompanyList();
    });
  }
}

function saveProgramToFirebase() {
  const userId = "user1";
  const start = document.getElementById('startDate').value;
  const end = document.getElementById('endDate').value;

  const program = {
    title: document.getElementById('progTitle').value.trim(),
    state: document.getElementById('progState').value,
    venue: document.getElementById('progVenue').value.trim(),
    dates: `${start} to ${end}`,
    slots: parseInt(document.getElementById('progSlots').value, 10),
    session: document.getElementById('progSession').value,
    cepPoints: document.getElementById('cepPoints').value
  };

  const programsRef = ref(database, `users/${userId}/Program`);

  if (currentEditKey) {
    const editRef = ref(database, `users/${userId}/Program/${currentEditKey}`);
    set(editRef, program)
      .then(() => {
        alert(`Program ${currentEditKey} updated!`);
        currentEditKey = null; // Clear after save
        loadProgramList(); // Refresh list
      })
      .catch(err => console.error("Error updating program:", err));
  } else {
    // Add new program
    get(programsRef).then(snapshot => {
      let newKey = "";
if (snapshot.exists()) {
  const programs = snapshot.val();
  let i = 1;
  while (programs[`program${i}`]) {
    i++;
  }
  newKey = `program${i}`;
} else {
  newKey = "program1";
}
      const newRef = ref(database, `users/${userId}/Program/${newKey}`);

      set(newRef, program)
        .then(() => {
          alert(`Program saved as ${newKey}`);
          loadProgramList(); // Refresh list
        })
        .catch(err => console.error("Error saving program:", err));
    }).catch(err => {
      // First time creation
      const newRef = ref(database, `users/${userId}/Program/program1`);
      set(newRef, program)
        .then(() => {
          alert(`Program path created and program1 saved!`);
          loadProgramList(); // Refresh list
        })
        .catch(err => console.error("Error initializing program path:", err));
    });
  }
}

function loadUsersFromFirebase() {
  const adminTbody = document.querySelector("#adminTable tbody");
  const respondentTbody = document.querySelector("#respondentTable tbody");

  const dbRef = ref(database, 'users');

  onValue(dbRef, (snapshot) => {
    adminTbody.innerHTML = "";
    respondentTbody.innerHTML = "";

    snapshot.forEach(childSnapshot => {
      const userId = childSnapshot.key;
      const user = childSnapshot.val();

      if (user.status === 'superadmin') return;

      const tr = document.createElement('tr');

      tr.setAttribute('data-user-id', userId);

      const fullnameTd = document.createElement('td');
      fullnameTd.textContent = user.fullname;
      tr.appendChild(fullnameTd);

      const companyTd = document.createElement('td');
      companyTd.textContent = user.Company || '-';
      tr.appendChild(companyTd);

      const departmentTd = document.createElement('td');
      departmentTd.textContent = user.Department || '-';
      tr.appendChild(departmentTd);

      const taskTd = document.createElement('td');
      taskTd.textContent = user.Task || '-';
      tr.appendChild(taskTd);

      const statusTd = document.createElement('td');
      statusTd.textContent = user.status || 'user';
      tr.appendChild(statusTd);

      const actionTd = document.createElement('td');
const actionWrapper = document.createElement('div');
actionWrapper.classList.add('action-buttons'); // Apply CSS flex style

      const makeAdminBtn = document.createElement('button');
      makeAdminBtn.textContent = 'Make Admin';
      makeAdminBtn.onclick = () => updateUserStatus(userId, 'admin');

      const revokeAdminBtn = document.createElement('button');
      revokeAdminBtn.textContent = 'Revoke Admin';
      revokeAdminBtn.onclick = () => updateUserStatus(userId, 'user');

      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'Remove';
      removeBtn.onclick = () => removeUser(userId);

      const editBtn = document.createElement('button');
      editBtn.textContent = 'Edit';
      editBtn.onclick = () => editUser(userId, user);

      if (user.status === 'admin') {
        actionWrapper.appendChild(revokeAdminBtn);
      } else {
        actionWrapper.appendChild(makeAdminBtn);
      }

      actionWrapper.appendChild(editBtn);
      actionWrapper.appendChild(removeBtn);
      actionTd.appendChild(actionWrapper);
      tr.appendChild(actionTd);

      if (user.status === 'admin') {
        adminTbody.appendChild(tr);
      } else {
        respondentTbody.appendChild(tr);
      }
    });
  });
}

function editUser(userId, user) {
  const userRef = ref(database, 'users/' + userId);
  const listCompanyRef = ref(database, 'users/user1/ListCompany');

  get(listCompanyRef).then(snapshot => {
    if (!snapshot.exists()) return alert("No company data found.");

    const companiesData = snapshot.val();
    const companyKeys = Object.keys(companiesData);

    const originalRow = document.querySelector(`[data-user-id="${userId}"]`);
    const tableBody = originalRow.parentElement;

    const editRow = document.createElement('tr');
    const nameInput = `<input type="text" id="editFullName" value="${user.fullname}" />`;

    const companySelect = document.createElement('select');
    companySelect.id = 'editCompany';
    companySelect.innerHTML = '<option value="">-- Select Company --</option>';
    companyKeys.forEach(key => {
      const opt = document.createElement('option');
      opt.value = key;
      opt.textContent = companiesData[key].name || key;
      if (companiesData[key].name === user.Company) opt.selected = true;
      companySelect.appendChild(opt);
    });

    const deptSelect = document.createElement('select');
    deptSelect.id = 'editDepartment';
    deptSelect.innerHTML = '<option value="">-- Select Department --</option>';

    const taskSelect = document.createElement('select');
    taskSelect.id = 'editTask';
    taskSelect.innerHTML = '<option value="">-- Select Task --</option>';

    const loadDepartments = () => {
      const selectedCompany = companySelect.value;
      deptSelect.innerHTML = '<option value="">-- Select Department --</option>';
      taskSelect.innerHTML = '<option value="">-- Select Task --</option>';
      if (!selectedCompany) return;

      const depts = companiesData[selectedCompany]?.departments || [];
      depts.forEach(dept => {
        const opt = document.createElement('option');
        opt.value = dept;
        opt.textContent = dept;
        if (dept === user.Department) opt.selected = true;
        deptSelect.appendChild(opt);
      });
      loadTasks();
    };

    const loadTasks = () => {
      const selectedCompany = companySelect.value;
      const selectedDept = deptSelect.value;
      taskSelect.innerHTML = '<option value="">-- Select Task --</option>';
      if (!selectedCompany || !selectedDept) return;

      const tasks = companiesData[selectedCompany]?.tasks?.[selectedDept] || [];
      tasks.forEach(task => {
        const opt = document.createElement('option');
        opt.value = task;
        opt.textContent = task;
        if (task === user.Task) opt.selected = true;
        taskSelect.appendChild(opt);
      });
    };

    companySelect.onchange = loadDepartments;
    deptSelect.onchange = loadTasks;

    // Trigger initial load
    loadDepartments();

    // Build the editable row
    editRow.innerHTML = `
      <td><input type="text" id="editFullName" value="${user.fullname}"></td>
      <td></td>
      <td></td>
      <td></td>
      <td>${user.status}</td>
      <td>
        <button id="saveEditBtn">Save</button>
        <button id="cancelEditBtn">Cancel</button>
      </td>
    `;
    editRow.querySelector('td:nth-child(2)').appendChild(companySelect);
    editRow.querySelector('td:nth-child(3)').appendChild(deptSelect);
    editRow.querySelector('td:nth-child(4)').appendChild(taskSelect);

    // Replace the original row with the edit row
    tableBody.replaceChild(editRow, originalRow);

    document.getElementById('saveEditBtn').onclick = () => {
      const updatedName = document.getElementById('editFullName').value.trim();
      const companyKey = companySelect.value;
      const updatedDept = deptSelect.value;
      const updatedTask = taskSelect.value;

      if (!updatedName || !companyKey || !updatedDept || !updatedTask) {
        alert("Please fill in all fields.");
        return;
      }

      const updatedCompany = companiesData[companyKey].name || companyKey;

      update(userRef, {
        fullname: updatedName,
        Company: updatedCompany,
        Department: updatedDept,
        Task: updatedTask
      }).then(() => {
        alert("User updated.");
        loadUsersFromFirebase(); // Reload user list
      });
    };

    document.getElementById('cancelEditBtn').onclick = () => {
      loadUsersFromFirebase(); // Restore original view
    };
  });
}

function loadProgramList() {
  const userId = "user1";
  const programsRef = ref(database, `users/${userId}/Program`);
  const tableBody = document.querySelector("#programListTable tbody");
  tableBody.innerHTML = "";

  const formatDate = (dateStr) => {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-GB', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
};

  get(programsRef).then(snapshot => {
    if (snapshot.exists()) {
      const programs = snapshot.val();
      Object.entries(programs).forEach(([key, data]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${data.title || '-'}</td>
          <td>${data.cepPoints || '-'}</td>
          <td>${data.state || '-'}</td>
          <td>${data.venue || '-'}</td>
          <td>${formatDate(data.dates?.split(" to ")[0])} to ${formatDate(data.dates?.split(" to ")[1])}</td>
          <td>${Object.keys(data.participants || {}).length} / ${data.slots || '-'}</td>
          <td><button onclick="manageParticipants('${key}')">Participants</button></td>
          <td>
    <button onclick="toggleFeeForm('${key}')">Fee</button>
    <div id="feeForm-${key}" style="display:none; margin-top:10px; border: 1px solid #ccc; padding: 8px; background: #f9f9f9; border-radius: 6px;">
      <select id="feeCategory-${key}" style="margin-bottom:5px; width: 80%;">
        <option value="">Fee Category</option>
        <option value="Competency">Competency</option>
        <option value="Non Competency">Non Competency</option>
        <option value="Refresher">Refresher</option>
      </select>
      <input type="number" id="feeAmount-${key}" placeholder="Amount (RM)" style="margin-bottom:5px; width: 70%;">
      <select id="feeLabel-${key}" style="margin-bottom:5px; width: 80%;">
        <option value="">Label</option>
        <option value="Early Bird">Early Bird</option>
        <option value="Standard">Standard</option>
        <option value="Company Sponsored">Company Sponsored</option>
      </select>
      <select id="feeDeadlineType-${key}" style="margin-bottom:5px; width: 80%;">
        <option value="">Deadline</option>
        <option value="Paid On / Before">Paid On / Before</option>
        <option value="Paid After">Paid After</option>
      </select>
      <input type="date" id="feeDeadlineDate-${key}" style="margin-bottom:5px; width: 70%;">
      <select id="feeMethod-${key}" style="margin-bottom:5px; width: 80%;">
        <option value="">Method</option>
        <option value="Cash">Cash</option>
        <option value="HRD Corp">HRD Corp</option>
        <option value="Company Sponsored">Company Sponsored</option>
      </select>
      <button onclick="saveFeeToProgram('${key}')">Save Fee</button>
    </div>
  </td>
          <td>
  <div style="display: flex; gap: 5px;">
    <button onclick="editProgram('${key}')">Edit</button>
    <button onclick="deleteProgram('${key}')">Delete</button>
  </div>
</td>
        `;
        tableBody.appendChild(tr);

        if (data.Fee) {
          const feeWrapper = document.createElement("div");
feeWrapper.id = `feeList-${key}`;
feeWrapper.style.display = "none"; // hidden by default

const feeTable = document.createElement("table");
feeTable.style.marginTop = "10px";
feeTable.style.borderCollapse = "collapse";
feeTable.style.width = "90%";
feeTable.style.margin = "10px auto";
feeTable.style.backgroundColor = "#f0f4f8";
feeTable.style.borderRadius = "8px";
feeTable.style.boxShadow = "0 2px 6px rgba(0, 0, 0, 0.1)";
feeTable.innerHTML = `
  <thead style="background-color: #1976d2; color: white;">
    <tr>
      <th>Category</th>
      <th>Amount (RM)</th>
      <th>Label</th>
      <th>Deadline Type</th>
      <th>Deadline Date</th>
      <th>Method</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    ${Object.entries(data.Fee).map(([feeId, fee]) => `
      <tr style="background-color: white; border-top: 1px solid #ddd;">
        <td>${fee.category || '-'}</td>
        <td>${fee.amount || '-'}</td>
        <td>${fee.label || '-'}</td>
        <td>${fee.deadlineType || '-'}</td>
        <td>${fee.deadlineDate || '-'}</td>
        <td>${fee.method || '-'}</td>
        <td>
          <button onclick="editFee('${key}', '${feeId}')" style="margin-right:5px; background:#4caf50; color:white; border:none; padding:4px 8px; border-radius:4px;">Edit</button>
          <button onclick="deleteFee('${key}', '${feeId}')" style="background:#f44336; color:white; border:none; padding:4px 8px; border-radius:4px;">Remove</button>
        </td>
      </tr>
    `).join("")}
  </tbody>
`;

feeWrapper.appendChild(feeTable);

const feeRow = document.createElement("tr");
const feeCell = document.createElement("td");
feeCell.colSpan = 10;
feeCell.appendChild(feeWrapper);
feeRow.appendChild(feeCell);
tableBody.appendChild(feeRow);
}
      });
    }
  });
}

let editingFeeId = null; // Global variable to track editing

window.saveFeeToProgram = function (programKey) {
  const userId = "user1";
  const progRef = ref(database, `users/${userId}/Program/${programKey}`);

  const fee = {
    category: document.getElementById(`feeCategory-${programKey}`).value,
    amount: parseFloat(document.getElementById(`feeAmount-${programKey}`).value),
    label: document.getElementById(`feeLabel-${programKey}`).value,
    deadlineType: document.getElementById(`feeDeadlineType-${programKey}`).value,
    deadlineDate: document.getElementById(`feeDeadlineDate-${programKey}`).value,
    method: document.getElementById(`feeMethod-${programKey}`).value,
  };

  get(progRef).then(snapshot => {
    if (!snapshot.exists()) return alert("Program not found.");
    const program = snapshot.val();
    const Fee = program.Fee || {};

    const feeId = editingFeeId || `fee${Date.now()}`;
    Fee[feeId] = fee;

    set(progRef, { ...program, Fee }).then(() => {
      alert(editingFeeId ? "Fee updated." : "Fee added.");
      editingFeeId = null;
      clearFeeForm(programKey);
      loadProgramList(); // Refresh fee display
      location.reload();
    });
  });
};


window.editProgram = function (key) {
  // Set the flag in localStorage when the Edit button is clicked
  localStorage.setItem("editingProgram", "true");

  // Show the Program Management section immediately when Edit is clicked
  document.getElementById('programManagementSection').style.display = 'block';

  const userId = "user1";
  const progRef = ref(database, `users/${userId}/Program/${key}`);
  get(progRef).then(snapshot => {
    if (snapshot.exists()) {
      const data = snapshot.val();
      currentEditKey = key; // 👈 Set this key

      document.getElementById('progTitle').value = data.title || "";
      document.getElementById('cepPoints').value = data.cepPoints || "";
      document.getElementById('progState').value = data.state || "";
      document.getElementById('progVenue').value = data.venue || "";
      const [start, end] = (data.dates || "").split(" to ");
      document.getElementById('startDate').value = start || "";
      document.getElementById('endDate').value = end || "";
      document.getElementById('progSlots').value = data.slots || "";
      document.getElementById('progSession').value = data.session || "";

      alert(`Loaded ${key} into form for editing`);
    }
  });
};

window.toggleFeeForm = function(programKey) {
  const formDiv = document.getElementById(`feeForm-${programKey}`);
  const feeListDiv = document.getElementById(`feeList-${programKey}`);
  const isVisible = formDiv.style.display === 'block';

  formDiv.style.display = isVisible ? 'none' : 'block';
  if (feeListDiv) {
    feeListDiv.style.display = isVisible ? 'none' : 'block';
  }
};


window.deleteFee = function (programKey, feeId) {
  const progRef = ref(database, `users/user1/Program/${programKey}`);
  get(progRef).then(snapshot => {
    const program = snapshot.val();
    if (program.Fee && program.Fee[feeId]) {
      delete program.Fee[feeId];
      set(progRef, program).then(() => {
        alert("Fee removed.");
        loadProgramList(); // refresh
      });
    }
  });
};

window.editFee = function (programKey, feeId) {
  const userId = "user1";
  const progRef = ref(database, `users/${userId}/Program/${programKey}`);

  get(progRef).then(snapshot => {
    if (!snapshot.exists()) return;

    const fee = snapshot.val().Fee?.[feeId];
    if (!fee) return;

    document.getElementById(`feeCategory-${programKey}`).value = fee.category || '';
    document.getElementById(`feeAmount-${programKey}`).value = fee.amount || '';
    document.getElementById(`feeLabel-${programKey}`).value = fee.label || '';
    document.getElementById(`feeDeadlineType-${programKey}`).value = fee.deadlineType || '';
    document.getElementById(`feeDeadlineDate-${programKey}`).value = fee.deadlineDate || '';
    document.getElementById(`feeMethod-${programKey}`).value = fee.method || '';

    editingFeeId = feeId;
    document.getElementById(`feeForm-${programKey}`).style.display = 'block';
    const feeList = document.getElementById(`feeList-${programKey}`);
    if (feeList) feeList.style.display = 'block';

    alert(`Now editing fee: ${fee.category} (${feeId})`);
  });
};

function clearFeeForm(programKey) {
  document.getElementById(`feeCategory-${programKey}`).value = '';
  document.getElementById(`feeAmount-${programKey}`).value = '';
  document.getElementById(`feeLabel-${programKey}`).value = '';
  document.getElementById(`feeDeadlineType-${programKey}`).value = '';
  document.getElementById(`feeDeadlineDate-${programKey}`).value = '';
  document.getElementById(`feeMethod-${programKey}`).value = '';
}

window.manageParticipants = function (programKey) {
  const container = document.getElementById("participantManager");

  if (container.style.display === "block") {
    container.style.display = "none"; // ✅ hide on second click
    return;
  }

  const userId = "user1";
  const progRef = ref(database, `users/${userId}/Program/${programKey}`);

  get(progRef).then(snapshot => {
    if (!snapshot.exists()) return alert("Program not found.");

    const data = snapshot.val();
    const participants = data.participants || {};
    const maxSlots = data.slots || 0;
    const participantKeys = Object.keys(participants);
    const remaining = maxSlots - participantKeys.length;

    container.style.display = "block";

    let html = `<h3>Participants for: ${data.title}</h3><ul id="participantList">`;

    participantKeys.forEach(pid => {
      html += `<li>${participants[pid]} 
        <button type="button" onclick="removeParticipant('${programKey}', '${pid}')">Remove</button></li>`;
    });

    html += `</ul>`;

    if (remaining > 0) {
      html += `
        <input type="text" id="newParticipantName" placeholder="New participant name">
        <button type="button" onclick="addParticipant('${programKey}')">Add</button>
      `;
    } else {
      html += `<p style="color:red;">All ${maxSlots} slots filled.</p>`;
    }

    container.innerHTML = html;
  });
};

// Add participant
window.addParticipant = function (programKey) {
  const userId = "user1";
  const input = document.getElementById('newParticipantName');
  if (!input) return alert("Input not found.");

  const name = input.value.trim();
  if (!name) return alert("Please enter a participant name.");

  const progRef = ref(database, `users/${userId}/Program/${programKey}`);
  get(progRef).then(snapshot => {
    const data = snapshot.val();
    const participants = data.participants || {};
    const count = Object.keys(participants).length;
    const max = data.slots || 0;

    if (count >= max) {
      alert("Maximum slots reached.");
      return;
    }

    const newKey = `p${Date.now()}`;
    participants[newKey] = name;

    set(progRef, { ...data, participants }).then(() => {
      alert("Participant added!");
      manageParticipants(programKey); // Refresh list
      location.reload();
    });
  });
};

// Remove participant
window.removeParticipant = function (programKey, pid) {
  const userId = "user1";
  const progRef = ref(database, `users/${userId}/Program/${programKey}`);

  get(progRef).then(snapshot => {
    const data = snapshot.val();
    if (!data.participants || !data.participants[pid]) return;

    delete data.participants[pid];

    set(progRef, data).then(() => {
      alert("Participant removed.");
      manageParticipants(programKey); // 👈 Refresh the participant list
      location.reload();
    });
  });
};

function updateUserStatus(userId, newStatus) {
  set(ref(database, `users/${userId}/status`), newStatus)
    .then(() => {
      alert(`User status updated to: ${newStatus}`);
      loadUsersFromFirebase();
    })
    .catch(err => console.error('Update failed:', err));
}

// Call this on page load
loadUsersFromFirebase();

function saveCompanyData() {
  const companyName = document.getElementById('companyInput').value.trim();
  const departments = Array.from(document.querySelectorAll('.department-input')).map(input => input.value.trim()).filter(Boolean);
  const tasks = Array.from(document.querySelectorAll('.task-input')).map(input => input.value.trim()).filter(Boolean);
  const tasksByDept = departments.reduce((obj, dept) => {
    obj[dept] = tasks;
    return obj;
  }, {});

  const companyRef = ref(database, `users/${userId}/ListCompany/${companyName}`);
  set(companyRef, {
    departments,
    tasks: tasksByDept
  }).then(() => {
    alert("Company saved.");
    populateCompanySelect();
    renderCompanyList();
  });
}

function populateCompanySelect() {
  const userId = "user1";
  const select = document.getElementById('companySelect');
  select.innerHTML = '<option value="">-- Select Company --</option>';

  const companiesRef = ref(database, `users/${userId}/ListCompany`);
  get(companiesRef).then(snapshot => {
    if (snapshot.exists()) {
      const companies = snapshot.val();
      Object.entries(companies).forEach(([key, company]) => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = company.name || key;
        select.appendChild(option);
      });
    }
  });
}

function addCompany() {
  const userId = "user1";
  const companyName = document.getElementById('companyInput').value.trim();
  if (!companyName) {
    alert("Company name is required.");
    return;
  }

  const listCompanyRef = ref(database, `users/${userId}/ListCompany`);

  get(listCompanyRef).then(snapshot => {
    let count = 0;
    if (snapshot.exists()) {
      const companies = snapshot.val();
      count = Object.keys(companies).length;
    }

    const newKey = `ListCompany${count + 1}`;
    const newCompanyRef = ref(database, `users/${userId}/ListCompany/${newKey}`);

    set(newCompanyRef, {
      name: companyName,
      departments: [],
      tasks: {}
    }).then(() => {
      alert("Company added.");
      populateCompanySelect();
      renderCompanyList();
      document.getElementById('companyInput').value = '';
    });
  });
}


document.getElementById('deptSelect').onchange = function () {
  selectedDepartment = this.value;
  document.getElementById('selectedDeptName').textContent = selectedDepartment || "[Select Department]";
  loadTasks();
};

function selectCompany() {
  selectedCompany = document.getElementById('companySelect').value;
  selectedDepartment = "";
  document.getElementById('selectedDeptName').textContent = '[Select Department]';
  loadDepartments();
  document.getElementById('taskList').innerHTML = '';
}

function deleteCompany() {
  const userId = "user1";

  if (selectedCompany && confirm(`Delete ${selectedCompany}?`)) {
    const companyRef = ref(database, `users/${userId}/ListCompany/${selectedCompany}`);

    set(companyRef, null).then(() => {
      alert("Company deleted.");
      location.reload(); // Reloads the page to refresh the UI
    }).catch(error => {
      console.error("🔥 Failed to delete company:", error);
    });
  }
}


function addDepartment() {
  const userId = "user1";
  const deptName = document.getElementById('deptInput').value.trim();
  if (!selectedCompany || !deptName) return;

  const companyRef = ref(database, `users/${userId}/ListCompany/${selectedCompany}`);
  get(companyRef).then(snapshot => {
    const data = snapshot.val();
    const departments = data.departments || [];
    if (!departments.includes(deptName)) departments.push(deptName);
    set(companyRef, { ...data, departments }).then(() => {
      alert("Department added.");
      loadDepartments();
      renderCompanyList();
    });
  });
}

function selectDepartment() {
  selectedDepartment = document.getElementById('deptSelect').value;
  document.getElementById('selectedDeptName').textContent = selectedDepartment || "[Select Department]";
  loadTasks();
}

function addTask() {
  const userId = "user1";
  const taskName = document.getElementById('taskInput').value.trim();
  if (!selectedCompany || !selectedDepartment || !taskName) return;

  const companyRef = ref(database, `users/${userId}/ListCompany/${selectedCompany}`);
  get(companyRef).then(snapshot => {
    const data = snapshot.val();
    const tasks = data.tasks || {};
    if (!tasks[selectedDepartment]) tasks[selectedDepartment] = [];
    tasks[selectedDepartment].push(taskName);
    set(companyRef, { ...data, tasks }).then(() => {
      alert("Task added.");
      loadTasks();
      renderCompanyList();
    });
  });
}

function loadDepartments() {
  const userId = "user1";
  const deptSelect = document.getElementById('deptSelect');
  deptSelect.innerHTML = '<option value="">-- Select Department --</option>';

  const companyRef = ref(database, `users/${userId}/ListCompany/${selectedCompany}`);
  get(companyRef).then(snapshot => {
    const data = snapshot.val();
    const departments = data.departments || [];

    const deptList = document.getElementById('deptList');
    deptList.innerHTML = '';

    departments.forEach((dept, index) => {
      const option = document.createElement('option');
      option.value = dept;
      option.textContent = dept;
      deptSelect.appendChild(option);

      const li = document.createElement('li');
      li.textContent = dept + ' ';
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.onclick = () => deleteDepartment(index);
      li.appendChild(delBtn);
      deptList.appendChild(li);
    });
  });
}

function deleteDepartment(index) {
  const userId = "user1";
  const companyRef = ref(database, `users/${userId}/ListCompany/${selectedCompany}`);
  get(companyRef).then(snapshot => {
    const data = snapshot.val();
    const departments = data.departments || [];
    const tasks = data.tasks || {};
    const deptName = departments[index];
    departments.splice(index, 1);
    delete tasks[deptName];
    set(companyRef, { ...data, departments, tasks }).then(() => {
      alert("Department deleted.");
      loadDepartments();
      renderCompanyList();
      location.reload();
    });
  });
}

window.deleteProgram = function (key) {
  const userId = "user1";
  if (!confirm(`Are you sure you want to delete ${key}?`)) return;

  const progRef = ref(database, `users/${userId}/Program/${key}`);
  set(progRef, null)
    .then(() => {
      alert(`${key} deleted.`);
      loadProgramList();
      if (currentEditKey === key) currentEditKey = null; // Reset if editing
    })
    .catch(err => console.error("Error deleting program:", err));
};

// Toggle for Program Management
let isProgramFormVisible = false;
function toggleProgramForm() {
    const section = document.getElementById('programManagementSection');
    if (!section) return;

    if (isProgramFormVisible) {
        section.style.display = 'none';
    } else {
        section.style.display = 'block';
    }

    isProgramFormVisible = !isProgramFormVisible;
}

function hideProgramForm() {
    const section = document.getElementById('programManagementSection');
    if (!section) return;

    section.style.display = 'none';
    isProgramFormVisible = false;
}

function hideCompany() {
    const section = document.getElementById('companyGroupSection');
    if (!section) return;

    section.style.display = 'none';
    isProgramFormVisible = false;
}

// Toggle for Company Management Group
let isCompanyGroupVisible = false;
function toggleCompanyGroup() {
  isCompanyGroupVisible = !isCompanyGroupVisible;
  document.getElementById('companyGroupSection').style.display = isCompanyGroupVisible ? 'block' : 'none';
  document.getElementById('toggleCompanyBtn').textContent = isCompanyGroupVisible ? 'Hide Add Company' : 'Add Company';
}

// Show Program list on load
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('programManagementSection').style.display = 'none';
  document.getElementById('companyGroupSection').style.display = 'none';
  renderCompanyList();

  const programSection = document.getElementById('programManagementSection');
  if (programSection) programSection.style.display = 'none';

  const addBtn = document.getElementById('toggleProgramBtn');
  if (addBtn) {
    addBtn.addEventListener('click', () => {
      // 🔥 Only runs when Add button is clicked
      currentEditKey = null;
      localStorage.removeItem("editingProgram");

      const clearFields = ["progTitle", "progState", "progVenue", "progSlots", "progSession", "cepPoints"];
      clearFields.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });

      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';

      programSection.style.display = 'block';
      isProgramFormVisible = true;

      alert("Switched to Add Mode: Ready to enter a new program.");
    });
  }
});


function deleteTask(index) {
  const userId = "user1";
  const companyRef = ref(database, `users/${userId}/ListCompany/${selectedCompany}`);
  get(companyRef).then(snapshot => {
    const data = snapshot.val();
    const tasks = data.tasks || {};
    tasks[selectedDepartment].splice(index, 1);
    set(companyRef, { ...data, tasks }).then(() => {
      alert("Task deleted.");
      loadTasks();
      renderCompanyList();
      location.reload();
    });
  });
}

function loadTasks() {
  const userId = "user1";
  const taskList = document.getElementById('taskList');
  taskList.innerHTML = '';

  const companyRef = ref(database, `users/${userId}/ListCompany/${selectedCompany}`);
  get(companyRef).then(snapshot => {
    const data = snapshot.val();
    const tasks = data.tasks?.[selectedDepartment] || [];

    tasks.forEach((task, index) => {
      const li = document.createElement('li');
      li.textContent = task + ' ';
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.onclick = () => deleteTask(index);
      li.appendChild(delBtn);
      taskList.appendChild(li);
    });
  });
}

    function logout() {
      sessionStorage.clear();
      window.location.href = 'https://asyrafergo.github.io/era/index.html';
    }

    populateCompanySelect();
    window.logout = logout;
window.addCompany = addCompany;
window.selectCompany = selectCompany;
window.selectDepartment = selectDepartment;
window.deleteCompany = deleteCompany;
window.addDepartment = addDepartment;
window.addTask = addTask;
window.saveProgramToFirebase = saveProgramToFirebase;
window.toggleProgramForm = toggleProgramForm;
window.toggleCompanyGroup = toggleCompanyGroup;
window.editCompany = editCompany;
window.toggleCompanyEdit = toggleCompanyEdit;
window.deleteCompanyEntry = deleteCompanyEntry;
window.hideProgramForm = hideProgramForm;
window.hideCompany = hideCompany;

loadProgramList();
  </script>
</body>
</html>
